<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMC æ¬Šé‡æ´¾æ¡ˆå¤§å¸«</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .lucide { display: inline-block; vertical-align: middle; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Lucide åœ–ç¤ºé©é…å™¨ ---
        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return <i data-lucide={name} style={{width: size, height: size}} className={className}></i>;
        };

        const Save = (p) => <Icon name="save" {...p} />;
        const Upload = (p) => <Icon name="upload" {...p} />;
        const UserPlus = (p) => <Icon name="user-plus" {...p} />;
        const Settings = (p) => <Icon name="settings" {...p} />;
        const PieChart = (p) => <Icon name="pie-chart" {...p} />;
        const History = (p) => <Icon name="history" {...p} />;
        const Calculator = (p) => <Icon name="calculator" {...p} />;
        const Trash2 = (p) => <Icon name="trash-2" {...p} />;
        const Edit3 = (p) => <Icon name="edit-3" {...p} />;
        const ArrowRight = (p) => <Icon name="arrow-right" {...p} />;

        // --- åˆå§‹é è¨­è³‡æ–™ ---
        const DEFAULT_PERSONNEL = ['Anita', 'Anny', 'Rita', 'Peggy'];
        const DEFAULT_WEIGHTS = {
            newCase: 10, oldCase: 5, classA: 5, classB: 5,
            enReport: 5, chReport: 8, reportCountUnit: 2,
            modeCountUnit: 1, chClassBBonus: 10
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [personnel, setPersonnel] = useState(DEFAULT_PERSONNEL);
            const [weights, setWeights] = useState(DEFAULT_WEIGHTS);
            const [records, setRecords] = useState([]);
            const [notification, setNotification] = useState(null);

            const [formData, setFormData] = useState({
                caseNumber: '', isNew: true, classType: 'B',
                hasEn: true, enCopies: 1, enModes: 1,
                hasCh: false, chCopies: 1, chModes: 1, manualAssignee: ''
            });

            const [dateRange, setDateRange] = useState({
                start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            });

            const showNotify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const parseCSVData = useCallback((text) => {
                const rows = text.split('\n').slice(1);
                const newRecords = [];
                rows.forEach(row => {
                    if (!row.trim()) return;
                    const cols = row.split(',');
                    if (cols.length >= 12) {
                        newRecords.push({
                            id: Number(cols[0]) || Date.now(), timestamp: new Date(cols[1]).toISOString(),
                            caseNumber: cols[2], assignee: cols[3], isNew: cols[4] === 'New',
                            classType: cols[5], hasEn: cols[6] === 'Yes', enCopies: Number(cols[7]), enModes: Number(cols[8]),
                            hasCh: cols[9] === 'Yes', chCopies: Number(cols[10]), chModes: Number(cols[11]), weight: Number(cols[12])
                        });
                    } else if (cols.length >= 10) {
                        const lang = cols[6];
                        newRecords.push({
                            id: Number(cols[0]) || Date.now(), timestamp: new Date(cols[1]).toISOString(),
                            caseNumber: cols[2], assignee: cols[3], isNew: cols[4] === 'New', classType: cols[5],
                            hasEn: lang === 'EN', enCopies: lang === 'EN' ? Number(cols[7]) : 0,
                            enModes: lang === 'EN' ? Number(cols[8]) : 0, hasCh: lang === 'CH',
                            chCopies: lang === 'CH' ? Number(cols[7]) : 0, chModes: lang === 'CH' ? Number(cols[8]) : 0,
                            weight: Number(cols[9])
                        });
                    }
                });
                return newRecords;
            }, []);

            useEffect(() => {
                const initData = async () => {
                    const savedData = localStorage.getItem('emc_data');
                    let localRecords = [];
                    if (savedData) {
                        try {
                            const parsed = JSON.parse(savedData);
                            if (parsed.personnel) setPersonnel(parsed.personnel);
                            if (parsed.weights) setWeights({ ...DEFAULT_WEIGHTS, ...parsed.weights });
                            if (parsed.records) localRecords = parsed.records;
                        } catch (e) { console.error(e); }
                    }
                    try {
                        const response = await fetch(`./data.csv?t=${Date.now()}`);
                        if (response.ok) {
                            const text = await response.text();
                            const serverRecords = parseCSVData(text);
                            const combinedRecords = [...localRecords];
                            const existingIds = new Set(localRecords.map(r => r.id));
                            serverRecords.forEach(srvRec => {
                                if (!existingIds.has(srvRec.id)) combinedRecords.push(srvRec);
                            });
                            combinedRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            setRecords(combinedRecords);
                        } else { setRecords(localRecords); }
                    } catch (e) { setRecords(localRecords); }
                };
                initData();
            }, [parseCSVData]);

            useEffect(() => {
                localStorage.setItem('emc_data', JSON.stringify({ personnel, weights, records }));
            }, [personnel, weights, records]);

            const calculateWeight = (data) => {
                let score = 0;
                score += data.isNew ? weights.newCase : weights.oldCase;
                score += data.classType === 'A' ? weights.classA : weights.classB;
                if (data.hasEn) {
                    score += weights.enReport;
                    score += (Number(data.enCopies) || 0) * weights.reportCountUnit;
                    score += (Number(data.enModes) || 0) * weights.modeCountUnit;
                }
                if (data.hasCh) {
                    score += weights.chReport;
                    score += (Number(data.chCopies) || 0) * weights.reportCountUnit;
                    score += (Number(data.chModes) || 0) * weights.modeCountUnit;
                    if (data.classType === 'B') score += (weights.chClassBBonus || 0);
                }
                return score;
            };

            const workloadStats = useMemo(() => {
                const stats = {};
                personnel.forEach(p => stats[p] = 0);
                const startDate = new Date(dateRange.start);
                const endDate = new Date(dateRange.end);
                endDate.setHours(23, 59, 59, 999);
                records.forEach(rec => {
                    const recDate = new Date(rec.timestamp);
                    if (recDate >= startDate && recDate <= endDate && personnel.includes(rec.assignee)) {
                        stats[rec.assignee] += (Number(rec.weight) || 0);
                    }
                });
                return Object.entries(stats).map(([name, weight]) => ({ name, weight })).sort((a, b) => a.weight - b.weight);
            }, [records, personnel, dateRange]);

            const recommendedAssignee = workloadStats.length > 0 ? workloadStats[0].name : personnel[0];

            const handleAssign = () => {
                if (!formData.caseNumber) return showNotify("è«‹è¼¸å…¥æ¡ˆè™Ÿï¼");
                if (!formData.hasEn && !formData.hasCh) return showNotify("è«‹é¸æ“‡å ±å‘Šé¡å‹ï¼");
                const currentWeight = calculateWeight(formData);
                const assignee = formData.manualAssignee || recommendedAssignee;
                const newRecord = {
                    id: Date.now(), timestamp: new Date().toISOString(),
                    caseNumber: formData.caseNumber, assignee, isNew: formData.isNew, classType: formData.classType,
                    hasEn: formData.hasEn, enCopies: Number(formData.enCopies), enModes: Number(formData.enModes),
                    hasCh: formData.hasCh, chCopies: Number(formData.chCopies), chModes: Number(formData.chModes), weight: currentWeight
                };
                setRecords([newRecord, ...records]);
                showNotify(`å·²æ´¾æ¡ˆçµ¦ ${assignee}`);
                setFormData(prev => ({ ...prev, caseNumber: '', manualAssignee: '' }));
            };

            const exportCSV = () => {
                const headers = ["ID", "æ™‚é–“", "æ¡ˆè™Ÿ", "äººå“¡", "æ–°èˆŠæ¡ˆ", "Class", "è‹±æ–‡å ±å‘Š", "è‹±æ–‡ä»½æ•¸", "è‹±æ–‡Mode", "ä¸­æ–‡å ±å‘Š", "ä¸­æ–‡ä»½æ•¸", "ä¸­æ–‡Mode", "ç¸½æ¬Šé‡"];
                const rows = records.map(r => [
                    r.id, new Date(r.timestamp).toLocaleString(), r.caseNumber, r.assignee, r.isNew?'New':'Old', r.classType,
                    r.hasEn?'Yes':'No', r.enCopies, r.enModes, r.hasCh?'Yes':'No', r.chCopies, r.chModes, r.weight
                ]);
                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.setAttribute("download", "data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotify("CSV ä¸‹è¼‰æˆåŠŸï¼");
            };

            const TabButton = ({ id, label, icon: IconComp }) => (
                <button onClick={() => setActiveTab(id)} className={`flex items-center gap-2 px-4 py-3 font-medium transition-all ${activeTab === id ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-slate-500 hover:bg-slate-50'}`}>
                    <IconComp size={18} /> {label}
                </button>
            );

            return (
                <div className="max-w-5xl mx-auto p-4 md:p-8">
                    <header className="flex justify-between items-center mb-8 text-slate-800">
                        <div>
                            <h1 className="text-3xl font-bold flex items-center gap-2"><Calculator className="text-blue-600" /> EMC æ¬Šé‡æ´¾æ¡ˆå¤§å¸«</h1>
                            <p className="text-slate-500 mt-1 italic">å…¬å¹³ã€å…¬æ­£ã€å…¬é–‹</p>
                        </div>
                    </header>

                    <nav className="bg-white rounded-t-xl shadow-sm border-b flex overflow-x-auto">
                        <TabButton id="dashboard" label="æ´¾æ¡ˆä¸­å¿ƒ" icon={PieChart} />
                        <TabButton id="history" label="æ­·å²ç´€éŒ„" icon={History} />
                        <TabButton id="settings" label="è¨­å®šèˆ‡æ¬Šé‡" icon={Settings} />
                        <TabButton id="data" label="è³‡æ–™ç®¡ç†" icon={Save} />
                    </nav>

                    <div className="bg-white rounded-b-xl shadow-lg p-6 min-h-[500px]">
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2 space-y-6">
                                    <div className="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-inner">
                                        <h2 className="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2"><Edit3 size={20}/> æ–°å¢æ´¾æ¡ˆ</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <input type="text" value={formData.caseNumber} onChange={e=>setFormData({...formData, caseNumber:e.target.value})} className="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="è¼¸å…¥æ¡ˆè™Ÿ"/>
                                            <div className="flex gap-2">
                                                <select value={formData.isNew?'New':'Old'} onChange={e=>setFormData({...formData, isNew:e.target.value==='New'})} className="flex-1 p-2 border rounded-lg bg-white shadow-sm"><option value="New">æ–°æ¡ˆ</option><option value="Old">èˆŠæ¡ˆ</option></select>
                                                <select value={formData.classType} onChange={e=>setFormData({...formData, classType:e.target.value})} className="flex-1 p-2 border rounded-lg bg-white shadow-sm"><option value="A">Class A</option><option value="B">Class B</option></select>
                                            </div>
                                        </div>
                                        <div className="space-y-3 mb-6">
                                            <div className={`p-3 rounded-lg border transition-all ${formData.hasEn?'bg-white border-blue-300 shadow-sm':'opacity-60'}`}><label className="flex items-center gap-2 font-bold cursor-pointer"><input type="checkbox" checked={formData.hasEn} onChange={e=>setFormData({...formData, hasEn:e.target.checked})} className="w-4 h-4"/> è‹±æ–‡å ±å‘Š</label>
                                            {formData.hasEn && <div className="flex gap-4 ml-6 mt-2"><div className="flex items-center gap-2"><span className="text-xs text-slate-500">ä»½æ•¸:</span><input type="number" value={formData.enCopies} onChange={e=>setFormData({...formData, enCopies:e.target.value})} className="w-16 border rounded p-1 text-sm"/></div><div className="flex items-center gap-2"><span className="text-xs text-slate-500">Modes:</span><input type="number" value={formData.enModes} onChange={e=>setFormData({...formData, enModes:e.target.value})} className="w-16 border rounded p-1 text-sm"/></div></div>}</div>
                                            <div className={`p-3 rounded-lg border transition-all ${formData.hasCh?'bg-white border-emerald-300 shadow-sm':'opacity-60'}`}><label className="flex items-center gap-2 font-bold cursor-pointer"><input type="checkbox" checked={formData.hasCh} onChange={e=>setFormData({...formData, hasCh:e.target.checked})} className="w-4 h-4"/> ä¸­æ–‡å ±å‘Š</label>
                                            {formData.hasCh && <div className="flex gap-4 ml-6 mt-2"><div className="flex items-center gap-2"><span className="text-xs text-slate-500">ä»½æ•¸:</span><input type="number" value={formData.chCopies} onChange={e=>setFormData({...formData, chCopies:e.target.value})} className="w-16 border rounded p-1 text-sm"/></div><div className="flex items-center gap-2"><span className="text-xs text-slate-500">Modes:</span><input type="number" value={formData.chModes} onChange={e=>setFormData({...formData, chModes:e.target.value})} className="w-16 border rounded p-1 text-sm"/></div></div>}</div>
                                        </div>
                                        <div className="flex justify-between items-center bg-white/80 p-4 rounded-lg border border-blue-100 mb-6">
                                            <span className="text-slate-600 font-medium italic">é ä¼°æ¬Šé‡ï¼š<strong className="text-3xl text-blue-600 ml-2">{calculateWeight(formData)}</strong></span>
                                            <button onClick={handleAssign} className="bg-blue-600 hover:bg-blue-700 text-white px-10 py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition-all">ç¢ºèªæ´¾æ¡ˆ</button>
                                        </div>
                                        <div className="flex flex-wrap gap-2 pt-4 border-t border-blue-200">
                                            {personnel.map(p => (<button key={p} onClick={()=>setFormData({...formData, manualAssignee:p})} className={`px-4 py-2 rounded-full text-sm font-medium border transition-all ${(formData.manualAssignee||recommendedAssignee)===p?'bg-blue-600 text-white shadow-md border-blue-600 ring-2 ring-blue-200':'bg-white text-slate-600'}`}>{p} {recommendedAssignee===p && !formData.manualAssignee && 'â˜…'}</button>))}
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-6">
                                    <div className="bg-white border rounded-xl p-6 shadow-sm">
                                        <h3 className="font-bold text-slate-800 mb-4">ç•¶å‰å·¥ä½œé‡çµ±è¨ˆ</h3>
                                        <div className="flex gap-2 items-center mb-4 text-xs"><input type="date" value={dateRange.start} onChange={e=>setDateRange({...dateRange, start:e.target.value})} className="border p-1 rounded w-full"/><ArrowRight size={12}/><input type="date" value={dateRange.end} onChange={e=>setDateRange({...dateRange, end:e.target.value})} className="border p-1 rounded w-full"/></div>
                                        <div className="space-y-4">{workloadStats.map((stat, idx) => (<div key={stat.name}><div className="flex justify-between text-sm mb-1"><span className={idx===0?'text-green-600 font-bold':'text-slate-700'}>{stat.name}</span><span className="font-bold text-slate-600 font-mono">{stat.weight} pts</span></div><div className="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden shadow-inner"><div className={`h-full rounded-full transition-all duration-500 ${idx===0?'bg-green-500':'bg-blue-400'}`} style={{ width: `${Math.min((stat.weight / (workloadStats[workloadStats.length-1].weight || 1)) * 100, 100)}%` }}></div></div></div>))}</div>
                                    </div>
                                    <div className="bg-amber-50 border border-amber-200 p-4 rounded-xl text-sm text-amber-800 italic">ğŸ’¡ æ´¾æ¡ˆæç¤ºï¼šå‹¾é¸å¤šèªè¨€æ™‚æ¬Šé‡æœƒç´¯åŠ ã€‚</div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="overflow-x-auto border rounded-xl">
                                <table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b font-bold text-slate-700 uppercase"><tr><th className="px-4 py-4">æ™‚é–“</th><th className="px-4 py-4">æ¡ˆè™Ÿ</th><th className="px-4 py-4">äººå“¡</th><th className="px-4 py-4">è©³æƒ…</th><th className="px-4 py-4 text-right">æ¬Šé‡</th><th className="px-4 py-4 text-center">åˆª</th></tr></thead>
                                <tbody>{records.map(rec => (<tr key={rec.id} className="border-b hover:bg-slate-50 transition-colors"><td className="px-4 py-4 text-slate-500">{new Date(rec.timestamp).toLocaleDateString()}</td><td className="px-4 py-4 font-bold text-slate-900">{rec.caseNumber}</td><td className="px-4 py-4"><span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold">{rec.assignee}</span></td><td className="px-4 py-4">{(rec.hasEn || rec.lang === 'EN') && 'ğŸ‡ºğŸ‡¸'}{(rec.hasCh || rec.lang === 'CH') && 'ğŸ‡¨ğŸ‡³'}</td><td className="px-4 py-4 text-right font-bold text-blue-600">{rec.weight}</td><td className="px-4 py-4 text-center"><button onClick={() => {if(confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) setRecords(records.filter(r=>r.id!==rec.id))}} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button></td></tr>))}</tbody>
                                </table>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">{/* äººå“¡ç®¡ç†å€ */}
                                <div className="bg-slate-50 p-6 rounded-xl border border-slate-200"><h3 className="font-bold mb-4 flex items-center gap-2"><UserPlus size={18}/> äººå“¡ç®¡ç†</h3>
                                <div className="space-y-2 mb-4">{personnel.map(p=>(<div key={p} className="flex justify-between items-center p-3 bg-white rounded-lg border shadow-sm"><span>{p}</span><button onClick={()=>setPersonnel(personnel.filter(n=>n!==p))} className="text-red-400" disabled={personnel.length<=1}><Trash2 size={16}/></button></div>))}</div>
                                <div className="flex gap-2"><input type="text" id="newN" className="flex-1 border p-2 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-400" placeholder="å§“å"/><button onClick={()=>{const n=document.getElementById('newN').value.trim(); if(n){setPersonnel([...personnel, n]); document.getElementById('newN').value=''}}} className="bg-blue-600 text-white px-4 rounded-lg text-sm">æ–°å¢</button></div></div>
                                {/* æ¬Šé‡è¨­å®šå€ */}
                                <div className="bg-slate-50 p-6 rounded-xl border border-slate-200"><h3 className="font-bold mb-4 flex items-center gap-2"><Settings size={18}/> åƒæ•¸è¨­å®š</h3>
                                <div className="space-y-2 overflow-y-auto max-h-80">{Object.entries(weights).map(([k,v])=>(<div key={k} className="flex justify-between items-center p-2 bg-white rounded border shadow-sm"><span className="text-xs font-mono text-slate-500">{k}</span><input type="number" value={v} onChange={e=>setWeights({...weights, [k]:Number(e.target.value)})} className="w-16 border rounded text-right p-1 text-sm focus:ring-1 focus:ring-blue-400 outline-none"/></div>))}</div></div>
                            </div>
                        )}

                        {activeTab === 'data' && (
                            <div className="flex flex-col items-center py-16 gap-8">
                                <div className="text-center space-y-2"><h3 className="text-2xl font-bold text-slate-800">è³‡æ–™åº«å‚™ä»½èˆ‡æ¢å¾©</h3><p className="text-slate-500 max-w-md">è³‡æ–™ç›®å‰ä¿å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ã€‚æ›é›»è…¦æ™‚ï¼Œè«‹å…ˆä¸‹è¼‰ CSVï¼Œå†ä¸Šå‚³è‡³æ–°é›»è…¦ã€‚</p></div>
                                <div className="flex flex-wrap gap-4 justify-center">
                                    <button onClick={exportCSV} className="bg-blue-600 text-white px-10 py-4 rounded-2xl font-bold flex items-center gap-3 shadow-xl hover:bg-blue-700 transition-all active:scale-95"><Save size={24}/> åŒ¯å‡ºè³‡æ–™åº« (CSV)</button>
                                    <label className="bg-emerald-600 text-white px-10 py-4 rounded-2xl font-bold flex items-center gap-3 shadow-xl cursor-pointer hover:bg-emerald-700 transition-all active:scale-95"><Upload size={24}/> æ‰‹å‹•åŒ¯å…¥ç´€éŒ„ <input type="file" className="hidden" accept=".csv" onChange={e=>{const r=new FileReader(); r.onload=ev=>{const d=parseCSVData(ev.target.result); setRecords(prev=>{const ids=new Set(prev.map(it=>it.id)); const uni=d.filter(it=>!ids.has(it.id)); return [...uni, ...prev]}); showNotify(`åŒ¯å…¥ ${d.length} ç­†è³‡æ–™`)}; r.readAsText(e.target.files[0])}}/></label>
                                </div>
                            </div>
                        )}
                    </div>
                    {notification && <div className="fixed bottom-6 right-6 bg-slate-900/90 text-white px-8 py-4 rounded-2xl shadow-2xl backdrop-blur-md animate-bounce border border-white/20 z-50">{notification}</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
