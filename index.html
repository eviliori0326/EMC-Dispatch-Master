<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMC æ¬Šé‡æ´¾æ¡ˆå¤§å¸«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            Save, Upload, UserPlus, Settings, PieChart, 
            History, Calculator, Trash2, Edit3, ArrowRight 
        } = lucide;

        // --- åˆå§‹é è¨­è³‡æ–™ ---
        const DEFAULT_PERSONNEL = ['Anita', 'Anny', 'Rita', 'Peggy'];
        const DEFAULT_WEIGHTS = {
            newCase: 10,
            oldCase: 5,
            classA: 5,
            classB: 5,
            enReport: 5,
            chReport: 8,
            reportCountUnit: 2,
            modeCountUnit: 1,
            chClassBBonus: 10
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [personnel, setPersonnel] = useState(DEFAULT_PERSONNEL);
            const [weights, setWeights] = useState(DEFAULT_WEIGHTS);
            const [records, setRecords] = useState([]);
            const [notification, setNotification] = useState(null);
            const [formData, setFormData] = useState({
                caseNumber: '', isNew: true, classType: 'A',
                hasEn: true, enCopies: 1, enModes: 1,
                hasCh: false, chCopies: 1, chModes: 1,
                manualAssignee: ''
            });
            const [dateRange, setDateRange] = useState({
                start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            });

            useEffect(() => {
                const savedData = localStorage.getItem('emc_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.personnel) setPersonnel(parsed.personnel);
                        if (parsed.weights) setWeights({ ...DEFAULT_WEIGHTS, ...parsed.weights });
                        if (parsed.records) setRecords(parsed.records);
                    } catch (e) { console.error("è®€å–å­˜æª”å¤±æ•—", e); }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('emc_data', JSON.stringify({ personnel, weights, records }));
            }, [personnel, weights, records]);

            const showNotify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const calculateWeight = (data) => {
                let score = 0;
                score += data.isNew ? weights.newCase : weights.oldCase;
                score += data.classType === 'A' ? weights.classA : weights.classB;
                if (data.hasEn) {
                    score += weights.enReport + (Number(data.enCopies) || 0) * weights.reportCountUnit + (Number(data.enModes) || 0) * weights.modeCountUnit;
                }
                if (data.hasCh) {
                    score += weights.chReport + (Number(data.chCopies) || 0) * weights.reportCountUnit + (Number(data.chModes) || 0) * weights.modeCountUnit;
                    if (data.classType === 'B') score += (weights.chClassBBonus || 0);
                }
                return score;
            };

            const workloadStats = useMemo(() => {
                const stats = {};
                personnel.forEach(p => stats[p] = 0);
                const startDate = new Date(dateRange.start);
                const endDate = new Date(dateRange.end);
                endDate.setHours(23, 59, 59, 999);

                records.forEach(rec => {
                    const recDate = new Date(rec.timestamp);
                    if (recDate >= startDate && recDate <= endDate && personnel.includes(rec.assignee)) {
                        stats[rec.assignee] += (Number(rec.weight) || 0);
                    }
                });
                return Object.entries(stats).map(([name, weight]) => ({ name, weight })).sort((a, b) => a.weight - b.weight);
            }, [records, personnel, dateRange]);

            const recommendedAssignee = workloadStats.length > 0 ? workloadStats[0].name : personnel[0];

            const handleAssign = () => {
                if (!formData.caseNumber) return showNotify("è«‹è¼¸å…¥æ¡ˆè™Ÿï¼");
                if (!formData.hasEn && !formData.hasCh) return showNotify("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®å ±å‘Šé¡å‹ï¼");
                const currentWeight = calculateWeight(formData);
                const assignee = formData.manualAssignee || recommendedAssignee;
                const newRecord = {
                    id: Date.now(), timestamp: new Date().toISOString(), caseNumber: formData.caseNumber,
                    assignee, isNew: formData.isNew, classType: formData.classType,
                    hasEn: formData.hasEn, enCopies: formData.hasEn ? Number(formData.enCopies) : 0, enModes: formData.hasEn ? Number(formData.enModes) : 0,
                    hasCh: formData.hasCh, chCopies: formData.hasCh ? Number(formData.chCopies) : 0, chModes: formData.hasCh ? Number(formData.chModes) : 0,
                    weight: currentWeight
                };
                setRecords([newRecord, ...records]);
                showNotify(`æ¡ˆè™Ÿ ${formData.caseNumber} å·²æ´¾çµ¦ ${assignee} (æ¬Šé‡: ${currentWeight})`);
                setFormData(prev => ({ ...prev, caseNumber: '', manualAssignee: '' }));
            };

            const exportCSV = () => {
                const headers = ["ID", "æ™‚é–“", "æ¡ˆè™Ÿ", "äººå“¡", "æ–°èˆŠæ¡ˆ", "Class", "è‹±æ–‡å ±å‘Š", "è‹±æ–‡ä»½æ•¸", "è‹±æ–‡Mode", "ä¸­æ–‡å ±å‘Š", "ä¸­æ–‡ä»½æ•¸", "ä¸­æ–‡Mode", "ç¸½æ¬Šé‡"];
                const rows = records.map(r => [
                    r.id, new Date(r.timestamp).toLocaleString(), r.caseNumber, r.assignee, r.isNew ? 'New' : 'Old', r.classType,
                    r.hasEn ? 'Yes' : 'No', r.enCopies, r.enModes, r.hasCh ? 'Yes' : 'No', r.chCopies, r.chModes, r.weight
                ]);
                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `EMC_Data_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            };

            const importCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const rows = text.split('\n').slice(1);
                    const newRecords = rows.map(row => {
                        const cols = row.split(',');
                        if (cols.length < 10) return null;
                        return {
                            id: Number(cols[0]) || Date.now(),
                            timestamp: new Date(cols[1]).toISOString(),
                            caseNumber: cols[2], assignee: cols[3],
                            isNew: cols[4] === 'New', classType: cols[5],
                            hasEn: cols[6] === 'Yes', enCopies: Number(cols[7]), enModes: Number(cols[8]),
                            hasCh: cols[9] === 'Yes', chCopies: Number(cols[10]), chModes: Number(cols[11]),
                            weight: Number(cols[12] || cols[9]) // ç°¡å–®ç›¸å®¹èˆŠç‰ˆ
                        };
                    }).filter(r => r);
                    setRecords(prev => {
                        const existingIds = new Set(prev.map(r => r.id));
                        return [...newRecords.filter(r => !existingIds.has(r.id)), ...prev].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    });
                    showNotify(`æˆåŠŸåŒ¯å…¥ ${newRecords.length} ç­†è³‡æ–™`);
                };
                reader.readAsText(file);
            };

            const TabButton = ({ id, label, icon: IconName }) => (
                <button onClick={() => setActiveTab(id)} className={`flex items-center gap-2 px-4 py-3 font-medium transition-all ${activeTab === id ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}>
                    <lucide.lucideReact.LucideIcon name={IconName} size={18} />
                    {label}
                </button>
            );

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-5xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                                    <Calculator className="text-blue-600" /> EMC æ¬Šé‡æ´¾æ¡ˆå¤§å¸«
                                </h1>
                                <p className="text-slate-500 mt-1">å…¬å¹³ã€å…¬æ­£ã€å…¬é–‹ï¼ˆæ”¯æ´å¤šé‡å ±å‘Šæ¨¡å¼ï¼‰</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-t-xl shadow-sm border-b border-slate-200 flex overflow-x-auto">
                            <button onClick={() => setActiveTab('dashboard')} className={`flex items-center gap-2 px-4 py-3 font-medium ${activeTab === 'dashboard' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-slate-500'}`}><PieChart size={18}/>æ´¾æ¡ˆä¸­å¿ƒ</button>
                            <button onClick={() => setActiveTab('history')} className={`flex items-center gap-2 px-4 py-3 font-medium ${activeTab === 'history' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-slate-500'}`}><History size={18}/>æ­·å²ç´€éŒ„</button>
                            <button onClick={() => setActiveTab('settings')} className={`flex items-center gap-2 px-4 py-3 font-medium ${activeTab === 'settings' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-slate-500'}`}><Settings size={18}/>è¨­å®šèˆ‡æ¬Šé‡</button>
                            <button onClick={() => setActiveTab('data')} className={`flex items-center gap-2 px-4 py-3 font-medium ${activeTab === 'data' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-slate-500'}`}><Save size={18}/>è³‡æ–™ç®¡ç†</button>
                        </div>

                        <div className="bg-white rounded-b-xl shadow-lg p-6 min-h-[500px]">
                            {activeTab === 'dashboard' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-2 space-y-6">
                                        <div className="bg-blue-50 p-6 rounded-xl border border-blue-100">
                                            <h2 className="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2"><Edit3 size={20}/> æ–°å¢æ´¾æ¡ˆ</h2>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">æ¡ˆè™Ÿ</label>
                                                    <input type="text" value={formData.caseNumber} onChange={(e) => setFormData({...formData, caseNumber: e.target.value})} placeholder="è¼¸å…¥ EMC æ¡ˆè™Ÿ" className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">æ¡ˆä»¶é¡å‹ & ç­‰ç´š</label>
                                                    <div className="flex gap-2">
                                                        <select value={formData.isNew ? 'New' : 'Old'} onChange={(e) => setFormData({...formData, isNew: e.target.value === 'New'})} className="flex-1 p-2 border border-slate-300 rounded-lg bg-white"><option value="New">æ–°æ¡ˆ (New)</option><option value="Old">èˆŠæ¡ˆ (Old)</option></select>
                                                        <select value={formData.classType} onChange={(e) => setFormData({...formData, classType: e.target.value})} className="flex-1 p-2 border border-slate-300 rounded-lg bg-white"><option value="A">Class A</option><option value="B">Class B</option></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr className="border-blue-200 my-4" />
                                            {/* å ±å‘Šé¡å‹è¨­å®š */}
                                            <div className="space-y-3">
                                                <div className={`p-3 rounded-lg border ${formData.hasEn ? 'bg-white border-blue-300 shadow-sm' : 'bg-slate-50'}`}>
                                                    <div className="flex items-center gap-3"><input type="checkbox" checked={formData.hasEn} onChange={(e) => setFormData({...formData, hasEn: e.target.checked})} className="w-5 h-5" /><span className="text-sm font-bold">è‹±æ–‡å ±å‘Š (English)</span></div>
                                                    {formData.hasEn && <div className="flex gap-4 ml-8 mt-2"><div>ä»½æ•¸: <input type="number" value={formData.enCopies} onChange={(e) => setFormData({...formData, enCopies: e.target.value})} className="w-16 p-1 border rounded" /></div><div>Mode: <input type="number" value={formData.enModes} onChange={(e) => setFormData({...formData, enModes: e.target.value})} className="w-16 p-1 border rounded" /></div></div>}
                                                </div>
                                                <div className={`p-3 rounded-lg border ${formData.hasCh ? 'bg-white border-emerald-300 shadow-sm' : 'bg-slate-50'}`}>
                                                    <div className="flex items-center gap-3"><input type="checkbox" checked={formData.hasCh} onChange={(e) => setFormData({...formData, hasCh: e.target.checked})} className="w-5 h-5" /><span className="text-sm font-bold">ä¸­æ–‡å ±å‘Š (Chinese)</span>{formData.hasCh && formData.classType === 'B' && <span className="text-xs bg-orange-100 px-2 rounded-full">ğŸ”¥ ç—›è‹¦åŠ æˆ</span>}</div>
                                                    {formData.hasCh && <div className="flex gap-4 ml-8 mt-2"><div>ä»½æ•¸: <input type="number" value={formData.chCopies} onChange={(e) => setFormData({...formData, chCopies: e.target.value})} className="w-16 p-1 border rounded" /></div><div>Mode: <input type="number" value={formData.chModes} onChange={(e) => setFormData({...formData, chModes: e.target.value})} className="w-16 p-1 border rounded" /></div></div>}
                                                </div>
                                            </div>
                                            <div className="mt-6 p-3 bg-white/60 rounded-lg flex justify-between items-center"><span className="text-sm">æœ¬æ¡ˆé ä¼°æ¬Šé‡ï¼š</span><span className="text-2xl font-bold text-blue-600">{calculateWeight(formData)}</span></div>
                                            <div className="mt-4"><label className="block text-sm mb-2">æŒ‡æ´¾äººå“¡ (å»ºè­°: <strong className="text-green-600">{recommendedAssignee}</strong>)</label><div className="flex flex-wrap gap-2">{personnel.map(p => <button key={p} onClick={() => setFormData({...formData, manualAssignee: p})} className={`px-4 py-2 rounded-full text-sm border transition-all ${(formData.manualAssignee || recommendedAssignee) === p ? 'bg-blue-600 text-white' : 'bg-white hover:border-blue-300'}`}>{p}</button>)}</div></div>
                                            <button onClick={handleAssign} className="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-md">ç¢ºèªæ´¾æ¡ˆ</button>
                                        </div>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="bg-white border p-6 rounded-xl shadow-sm">
                                            <h3 className="font-bold mb-4">ç•¶å‰å·¥ä½œé‡çµ±è¨ˆ ({dateRange.start} ~ {dateRange.end})</h3>
                                            <div className="space-y-4">{workloadStats.map((stat, idx) => (
                                                <div key={stat.name}><div className="flex justify-between text-sm mb-1"><span className={idx === 0 ? 'text-green-600 font-bold' : ''}>{stat.name}</span><span>{stat.weight} pts</span></div>
                                                <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div className={`h-2.5 ${idx === 0 ? 'bg-green-500' : 'bg-blue-400'}`} style={{ width: `${Math.min((stat.weight / (workloadStats[workloadStats.length-1].weight || 1)) * 100, 100)}%` }}></div></div></div>
                                            ))}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'history' && (
                                <div>
                                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">æ­·å²æ´¾æ¡ˆç´€éŒ„</h2><span>å…± {records.length} ç­†</span></div>
                                    <div className="overflow-x-auto border rounded-lg">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 border-b"><tr><th className="px-4 py-3">æ™‚é–“</th><th className="px-4 py-3">æ¡ˆè™Ÿ</th><th className="px-4 py-3">äººå“¡</th><th className="px-4 py-3 text-right">æ¬Šé‡</th><th className="px-4 py-3 text-center">æ“ä½œ</th></tr></thead>
                                            <tbody>{records.map(rec => (
                                                <tr key={rec.id} className="border-b hover:bg-slate-50"><td className="px-4 py-3">{new Date(rec.timestamp).toLocaleDateString()}</td><td className="px-4 py-3 font-bold">{rec.caseNumber}</td><td className="px-4 py-3"><span className="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">{rec.assignee}</span></td><td className="px-4 py-3 text-right">{rec.weight}</td><td className="px-4 py-3 text-center"><button onClick={() => { if(confirm('åˆªé™¤ï¼Ÿ')) setRecords(records.filter(r => r.id !== rec.id)) }} className="text-red-500"><Trash2 size={16}/></button></td></tr>
                                            ))}</tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div><h2 className="text-xl font-bold mb-4 flex items-center gap-2"><UserPlus size={20}/> äººå“¡ç®¡ç†</h2>
                                        <div className="bg-white border rounded-xl p-4 space-y-2">{personnel.map(p => (
                                            <div key={p} className="flex justify-between items-center p-2 bg-slate-50 rounded"><span>{p}</span><button onClick={() => setPersonnel(personnel.filter(n => n !== p))} className="text-red-400" disabled={personnel.length <= 1}><Trash2 size={16}/></button></div>
                                        ))}<div className="flex gap-2 mt-4 pt-4 border-t"><input type="text" id="newP" placeholder="å§“å" className="flex-1 border rounded px-2" /><button onClick={() => { const val = document.getElementById('newP').value; if(val) { setPersonnel([...personnel, val]); document.getElementById('newP').value = ''; } }} className="bg-blue-600 text-white px-3 py-1 rounded">æ–°å¢</button></div></div>
                                    </div>
                                    <div><h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Settings size={20}/> æ¬Šé‡åƒæ•¸</h2>
                                        <div className="bg-white border rounded-xl p-4 space-y-3">{Object.entries(weights).map(([k, v]) => (
                                            <div key={k} className="flex justify-between items-center"><label className="text-sm">{k}</label><input type="number" value={v} onChange={(e) => setWeights({...weights, [k]: Number(e.target.value)})} className="w-20 border rounded px-2 py-1 text-right" /></div>
                                        ))}</div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'data' && (
                                <div className="flex flex-col items-center py-10 space-y-6">
                                    <div className="text-center"><h2 className="text-2xl font-bold">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h2><p className="text-slate-500">æ‰€æœ‰çš„ç´€éŒ„éƒ½å­˜åœ¨æ­¤ç€è¦½å™¨ä¸­ï¼Œè«‹å®šæœŸä¸‹è¼‰ CSV å‚™ä»½ã€‚</p></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                                        <div className="bg-blue-50 border p-6 rounded-xl text-center"><Save size={48} className="mx-auto text-blue-600 mb-4"/><button onClick={exportCSV} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">åŒ¯å‡º CSV</button></div>
                                        <div className="bg-emerald-50 border p-6 rounded-xl text-center"><Upload size={48} className="mx-auto text-emerald-600 mb-4"/><label className="bg-emerald-600 text-white px-6 py-2 rounded-lg font-medium cursor-pointer inline-block">åŒ¯å…¥ CSV<input type="file" accept=".csv" onChange={importCSV} className="hidden"/></label></div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {notification && <div className="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl animate-bounce">{notification}</div>}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
