<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMC 權重派案大師</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* 修正網頁版圖示微調 */
        .lucide { display: inline-block; vertical-align: middle; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Lucide 圖示適配器 ---
        const Icon = ({ name, size = 18, class: className }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });
            return <i data-lucide={name} style={{width: size, height: size}} class={className}></i>;
        };

        // 定義組件中用到的圖示
        const Save = (p) => <Icon name="save" {...p} />;
        const Upload = (p) => <Icon name="upload" {...p} />;
        const UserPlus = (p) => <Icon name="user-plus" {...p} />;
        const Settings = (p) => <Icon name="settings" {...p} />;
        const PieChart = (p) => <Icon name="pie-chart" {...p} />;
        const History = (p) => <Icon name="history" {...p} />;
        const Calculator = (p) => <Icon name="calculator" {...p} />;
        const Trash2 = (p) => <Icon name="trash-2" {...p} />;
        const Edit3 = (p) => <Icon name="edit-3" {...p} />;
        const ArrowRight = (p) => <Icon name="arrow-right" {...p} />;
        const CheckSquare = (p) => <Icon name="check-square" {...p} />;
        const Square = (p) => <Icon name="square" {...p} />;

        // --- 初始預設資料 ---
        const DEFAULT_PERSONNEL = ['Anita', 'Anny', 'Rita', 'Peggy'];
        const DEFAULT_WEIGHTS = {
            newCase: 10, oldCase: 5, classA: 5, classB: 5,
            enReport: 5, chReport: 8, reportCountUnit: 2,
            modeCountUnit: 1, chClassBBonus: 10
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [personnel, setPersonnel] = useState(DEFAULT_PERSONNEL);
            const [weights, setWeights] = useState(DEFAULT_WEIGHTS);
            const [records, setRecords] = useState([]);
            const [notification, setNotification] = useState(null);

            const [formData, setFormData] = useState({
                caseNumber: '', isNew: true, classType: 'A',
                hasEn: true, enCopies: 1, enModes: 1,
                hasCh: false, chCopies: 1, chModes: 1, manualAssignee: ''
            });

            const [dateRange, setDateRange] = useState({
                start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            });

            useEffect(() => {
                const savedData = localStorage.getItem('emc_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.personnel) setPersonnel(parsed.personnel);
                        if (parsed.weights) setWeights(parsed.weights);
                        if (parsed.records) setRecords(parsed.records);
                    } catch (e) { console.error("讀取失敗", e); }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('emc_data', JSON.stringify({ personnel, weights, records }));
            }, [personnel, weights, records]);

            const showNotify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const calculateWeight = (data) => {
                let score = 0;
                score += data.isNew ? weights.newCase : weights.oldCase;
                score += data.classType === 'A' ? weights.classA : weights.classB;
                if (data.hasEn) {
                    score += weights.enReport;
                    score += (Number(data.enCopies) || 0) * weights.reportCountUnit;
                    score += (Number(data.enModes) || 0) * weights.modeCountUnit;
                }
                if (data.hasCh) {
                    score += weights.chReport;
                    score += (Number(data.chCopies) || 0) * weights.reportCountUnit;
                    score += (Number(data.chModes) || 0) * weights.modeCountUnit;
                    if (data.classType === 'B') score += weights.chClassBBonus;
                }
                return score;
            };

            const workloadStats = useMemo(() => {
                const stats = {};
                personnel.forEach(p => stats[p] = 0);
                const startDate = new Date(dateRange.start);
                const endDate = new Date(dateRange.end);
                endDate.setHours(23, 59, 59, 999);

                records.forEach(rec => {
                    const recDate = new Date(rec.timestamp);
                    if (recDate >= startDate && recDate <= endDate && personnel.includes(rec.assignee)) {
                        stats[rec.assignee] += rec.weight;
                    }
                });
                return Object.entries(stats).map(([name, weight]) => ({ name, weight })).sort((a, b) => a.weight - b.weight);
            }, [records, personnel, dateRange]);

            const recommendedAssignee = workloadStats.length > 0 ? workloadStats[0].name : personnel[0];

            const handleAssign = () => {
                if (!formData.caseNumber) return showNotify("請輸入案號！");
                if (!formData.hasEn && !formData.hasCh) return showNotify("請至少選擇一種報告類型！");

                const currentWeight = calculateWeight(formData);
                const assignee = formData.manualAssignee || recommendedAssignee;

                const newRecord = {
                    id: Date.now(), timestamp: new Date().toISOString(),
                    caseNumber: formData.caseNumber, assignee,
                    isNew: formData.isNew, classType: formData.classType,
                    hasEn: formData.hasEn, enCopies: Number(formData.enCopies), enModes: Number(formData.enModes),
                    hasCh: formData.hasCh, chCopies: Number(formData.chCopies), chModes: Number(formData.chModes),
                    weight: currentWeight
                };

                setRecords([newRecord, ...records]);
                showNotify(`已派給 ${assignee}`);
                setFormData(prev => ({ ...prev, caseNumber: '', manualAssignee: '' }));
            };

            const exportCSV = () => {
                const headers = ["時間", "案號", "人員", "新舊案", "Class", "總權重"];
                const rows = records.map(r => [new Date(r.timestamp).toLocaleString(), r.caseNumber, r.assignee, r.isNew ? 'New' : 'Old', r.classType, r.weight]);
                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `EMC_Data_${new Date().toLocaleDateString()}.csv`;
                link.click();
            };

            const TabButton = ({ id, label, icon: IconComp }) => (
                <button onClick={() => setActiveTab(id)} class={`flex items-center gap-2 px-4 py-3 font-medium transition-all ${activeTab === id ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-slate-500 hover:bg-slate-50'}`}>
                    <IconComp size={18} /> {label}
                </button>
            );

            return (
                <div class="max-w-5xl mx-auto p-4 md:p-8">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-2"><Calculator class="text-blue-600" /> EMC 權重派案大師</h1>
                            <p class="text-slate-500 mt-1">公平、公正、公開（支援多重報告模式）</p>
                        </div>
                    </div>

                    <nav class="bg-white rounded-t-xl shadow-sm border-b flex overflow-x-auto">
                        <TabButton id="dashboard" label="派案中心" icon={PieChart} />
                        <TabButton id="history" label="歷史紀錄" icon={History} />
                        <TabButton id="settings" label="設定與權重" icon={Settings} />
                        <TabButton id="data" label="資料管理" icon={Save} />
                    </nav>

                    <div class="bg-white rounded-b-xl shadow-lg p-6 min-h-[500px]">
                        {activeTab === 'dashboard' && (
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2 space-y-6">
                                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                                        <h2 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2"><Edit3 size={20}/> 新增派案</h2>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">案號</label>
                                                <input type="text" value={formData.caseNumber} onChange={e => setFormData({...formData, caseNumber: e.target.value})} class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="案號"/>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">類型</label>
                                                <div class="flex gap-2">
                                                    <select value={formData.isNew ? 'New' : 'Old'} onChange={e => setFormData({...formData, isNew: e.target.value === 'New'})} class="flex-1 p-2 border rounded-lg bg-white">
                                                        <option value="New">新案</option><option value="Old">舊案</option>
                                                    </select>
                                                    <select value={formData.classType} onChange={e => setFormData({...formData, classType: e.target.value})} class="flex-1 p-2 border rounded-lg bg-white">
                                                        <option value="A">Class A</option><option value="B">Class B</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="space-y-3 mb-6">
                                            <div class={`p-3 rounded-lg border ${formData.hasEn ? 'bg-white border-blue-300' : 'bg-slate-50 opacity-60'}`}>
                                                <button onClick={() => setFormData({...formData, hasEn: !formData.hasEn})} class="flex items-center gap-2 text-sm font-bold">
                                                    {formData.hasEn ? <CheckSquare size={18} /> : <Square size={18} />} 英文報告
                                                </button>
                                                {formData.hasEn && <div class="flex gap-4 ml-7 mt-2">
                                                    <input type="number" value={formData.enCopies} onChange={e=>setFormData({...formData, enCopies:e.target.value})} class="w-20 border rounded p-1" placeholder="份數"/>
                                                    <input type="number" value={formData.enModes} onChange={e=>setFormData({...formData, enModes:e.target.value})} class="w-20 border rounded p-1" placeholder="Modes"/>
                                                </div>}
                                            </div>
                                            <div class={`p-3 rounded-lg border ${formData.hasCh ? 'bg-white border-emerald-300' : 'bg-slate-50 opacity-60'}`}>
                                                <button onClick={() => setFormData({...formData, hasCh: !formData.hasCh})} class="flex items-center gap-2 text-sm font-bold">
                                                    {formData.hasCh ? <CheckSquare size={18} /> : <Square size={18} />} 中文報告
                                                </button>
                                                {formData.hasCh && <div class="flex gap-4 ml-7 mt-2">
                                                    <input type="number" value={formData.chCopies} onChange={e=>setFormData({...formData, chCopies:e.target.value})} class="w-20 border rounded p-1" placeholder="份數"/>
                                                    <input type="number" value={formData.chModes} onChange={e=>setFormData({...formData, chModes:e.target.value})} class="w-20 border rounded p-1" placeholder="Modes"/>
                                                </div>}
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center mb-6 px-2">
                                            <span class="text-sm font-bold text-slate-600">預估權重：<span class="text-2xl text-blue-600">{calculateWeight(formData)}</span></span>
                                            <button onClick={handleAssign} class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95">確認派案</button>
                                        </div>
                                        <div class="flex flex-wrap gap-2 pt-4 border-t border-blue-200">
                                            {personnel.map(p => (
                                                <button key={p} onClick={() => setFormData({...formData, manualAssignee: p})} class={`px-4 py-2 rounded-full text-sm font-medium border transition-all ${ (formData.manualAssignee || recommendedAssignee) === p ? 'bg-blue-600 text-white border-blue-600 ring-2 ring-blue-100' : 'bg-white text-slate-600'}`}>
                                                    {p} {recommendedAssignee === p && !formData.manualAssignee && '★'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-6">
                                    <div class="bg-white border rounded-xl p-6 shadow-sm">
                                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><PieChart size={18}/> 工作量統計</h3>
                                        <div class="space-y-4">
                                            {workloadStats.map((stat, idx) => (
                                                <div key={stat.name}>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span class={idx === 0 ? 'text-green-600 font-bold' : 'text-slate-700'}>{stat.name}</span>
                                                        <span class="font-bold text-slate-600">{stat.weight} pts</span>
                                                    </div>
                                                    <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                                        <div class={`h-full rounded-full ${idx === 0 ? 'bg-green-500' : 'bg-blue-400'}`} style={{ width: `${Math.min((stat.weight / (workloadStats[workloadStats.length-1].weight || 1)) * 100, 100)}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 border-b text-slate-700 font-bold">
                                        <tr><th class="px-4 py-3">時間</th><th class="px-4 py-3">案號</th><th class="px-4 py-3">人員</th><th class="px-4 py-3">類型</th><th class="px-4 py-3 text-right">權重</th><th class="px-4 py-3 text-center">刪除</th></tr>
                                    </thead>
                                    <tbody>
                                        {records.map(rec => (
                                            <tr key={rec.id} class="border-b hover:bg-slate-50">
                                                <td class="px-4 py-3 text-slate-500">{new Date(rec.timestamp).toLocaleDateString()}</td>
                                                <td class="px-4 py-3 font-bold text-slate-900">{rec.caseNumber}</td>
                                                <td class="px-4 py-3"><span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-bold">{rec.assignee}</span></td>
                                                <td class="px-4 py-3">{rec.isNew ? '新' : '舊'} / {rec.classType}</td>
                                                <td class="px-4 py-3 text-right font-bold text-blue-600">{rec.weight}</td>
                                                <td class="px-4 py-3 text-center"><button onClick={() => {if(confirm('刪除？')) setRecords(records.filter(r=>r.id!==rec.id))}} class="text-red-400 hover:text-red-600"><Trash2 size={16}/></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-slate-50 p-6 rounded-xl border">
                                    <h3 class="font-bold mb-4">工程師管理</h3>
                                    <div class="space-y-2">
                                        {personnel.map(p => (
                                            <div key={p} class="flex justify-between items-center p-2 bg-white rounded border">
                                                <span>{p}</span><button onClick={() => setPersonnel(personnel.filter(n=>n!==p))} class="text-red-400">刪除</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div class="bg-slate-50 p-6 rounded-xl border">
                                    <h3 class="font-bold mb-4">權重數值設定</h3>
                                    <div class="grid grid-cols-1 gap-2">
                                        {Object.entries(weights).map(([k, v]) => (
                                            <div key={k} class="flex justify-between items-center bg-white p-2 border rounded">
                                                <span class="text-xs font-bold text-slate-500 uppercase">{k}</span>
                                                <input type="number" value={v} onChange={e=>setWeights({...weights, [k]: Number(e.target.value)})} class="w-16 border rounded text-right p-1"/>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'data' && (
                            <div class="flex flex-col items-center py-12 gap-6">
                                <div class="text-center mb-4">
                                    <h3 class="text-lg font-bold">本地儲存空間 (LocalStorage)</h3>
                                    <p class="text-slate-500">資料已自動儲存在此瀏覽器，若清除快取資料將會遺失。</p>
                                </div>
                                <button onClick={exportCSV} class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg"><Save size={20}/> 匯出 CSV 備份</button>
                                <label class="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg cursor-pointer">
                                    <Upload size={20}/> 恢復資料庫
                                    <input type="file" class="hidden" onChange={(e) => {
                                        const reader = new FileReader();
                                        reader.onload = (ev) => {
                                            try {
                                                const csv = ev.target.result;
                                                alert("CSV 解析功能需視您的匯入格式而定，建議使用本系統匯出的檔案。");
                                            } catch(err) { alert("讀取錯誤"); }
                                        };
                                        reader.readAsText(e.target.files[0]);
                                    }} />
                                </label>
                            </div>
                        )}
                    </div>
                    {notification && <div class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl animate-bounce">{notification}</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
