<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMC Ê¨äÈáçÊ¥æÊ°àÂ§ßÂ∏´</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* ÈÅøÂÖçËÆÄÂèñÊôÇÈñÉÁàç */
        body { opacity: 0; animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- Áí∞Â¢ÉÈÅ©ÈÖçÂçÄ (Adapter Layer) ---
        // Ëß£Êßã React HooksÔºåËÆì‰∏ãÊñπÂéüÊú¨ÁöÑÁ®ãÂºèÁ¢º‰∏çÁî®Êîπ
        const { useState, useEffect, useMemo, useCallback } = React;

        // Ê®°Êì¨ lucide-react ÁöÑÁµÑ‰ª∂Ë°åÁÇ∫
        // Âõ†ÁÇ∫ÁÄèË¶ΩÂô®Á´Ø‰∏çËÉΩÁõ¥Êé• importÔºåÊàëÂÄëÁî® lucide ÂÖ®ÂüüËÆäÊï∏‰æÜÁî¢ÁîüÂ∞çÊáâÁöÑ SVG ÁµÑ‰ª∂
        const LucideIcon = ({ name, size = 24, className, ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            
            // Â∞á lucide ÁöÑ icon ËΩâÊèõÁÇ∫ React SVG
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                    {...props}
                >
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        // ÂÆöÁæ©ÂéüÊú¨Á®ãÂºèÁ¢º‰∏≠Áî®Âà∞ÁöÑÊâÄÊúâÂúñÊ®ôÁµÑ‰ª∂
        const Save = (props) => <LucideIcon name="Save" {...props} />;
        const Upload = (props) => <LucideIcon name="Upload" {...props} />;
        const UserPlus = (props) => <LucideIcon name="UserPlus" {...props} />;
        const Settings = (props) => <LucideIcon name="Settings" {...props} />;
        const PieChart = (props) => <LucideIcon name="PieChart" {...props} />;
        const History = (props) => <LucideIcon name="History" {...props} />;
        const Calculator = (props) => <LucideIcon name="Calculator" {...props} />;
        const Trash2 = (props) => <LucideIcon name="Trash2" {...props} />;
        const Edit3 = (props) => <LucideIcon name="Edit3" {...props} />;
        const ArrowRight = (props) => <LucideIcon name="ArrowRight" {...props} />;

        // --- ‰ª•‰∏ãÂÆåÂÖ®ÊòØÊÇ®ÂéüÊú¨ÁöÑÁ®ãÂºèÁ¢º (Original Code) ---
        
        // --- ÂàùÂßãÈ†êË®≠Ë≥áÊñô ---
        const DEFAULT_PERSONNEL = ['Anita', 'Anny', 'Rita', 'Peggy'];

        const DEFAULT_WEIGHTS = {
            newCase: 10,       // Êñ∞Ê°à
            oldCase: 5,        // ËàäÊ°à
            classA: 5,         // Class A
            classB: 5,         // Class B
            enReport: 5,       // Ëã±ÊñáÂ†±ÂëäÂü∫Êú¨ÂàÜ
            chReport: 8,       // ‰∏≠ÊñáÂ†±ÂëäÂü∫Êú¨ÂàÜ
            reportCountUnit: 2,// ÊØè‰ªΩÂ†±ÂëäÂñÆÂÉπ
            modeCountUnit: 1,  // ÊØèÂÄã Mode ÂñÆÂÉπ
            chClassBBonus: 10  // ‰∏≠ÊñáÂ†±Âëä + Class B ÁöÑÈ°çÂ§ñÂä†Ê¨ä (ÁóõËã¶Âä†Êàê)
        };

        const App = () => {
            // --- State ÁÆ°ÁêÜ ---
            const [activeTab, setActiveTab] = useState('dashboard'); // dashboard, history, settings, data
            const [personnel, setPersonnel] = useState(DEFAULT_PERSONNEL);
            const [weights, setWeights] = useState(DEFAULT_WEIGHTS);
            const [records, setRecords] = useState([]);
            const [notification, setNotification] = useState(null);

            // --- Ê¥æÊ°àË°®ÂñÆ State (ÂçáÁ¥öÁâà) ---
            const [formData, setFormData] = useState({
                caseNumber: '',
                isNew: true,
                classType: 'B', // ÊîπÁÇ∫È†êË®≠ Class B
                // ÊîπÁÇ∫Áç®Á´ãÊéßÂà∂‰∏≠Ëã±Êñá
                hasEn: true,
                enCopies: 1,
                enModes: 1,
                hasCh: false, // È†êË®≠‰∏çÂãæÈÅ∏‰∏≠Êñá
                chCopies: 1,
                chModes: 1,
                manualAssignee: ''
            });

            // --- ÁØ©ÈÅ∏ÊôÇÈñìÂçÄÈñì (È†êË®≠ÈÅéÂéª 30 Â§©) ---
            const [dateRange, setDateRange] = useState({
                start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            });

            // --- È°ØÁ§∫ÈÄöÁü• ---
            const showNotify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            // --- ÂÖ±Áî®ÔºöCSV Ëß£ÊûêÈÇèËºØ ---
            const parseCSVData = useCallback((text) => {
                const rows = text.split('\n').slice(1); // Skip header
                const newRecords = [];

                rows.forEach(row => {
                    if (!row.trim()) return;
                    const cols = row.split(',');
                    // Ê™¢Êü•Ê¨Ñ‰ΩçÊï∏Èáè‰æÜÂà§Êñ∑ÊòØËàäÊ†ºÂºèÈÇÑÊòØÊñ∞Ê†ºÂºè
                    if (cols.length >= 12) {
                        // Êñ∞Ê†ºÂºè
                        newRecords.push({
                            id: Number(cols[0]) || Date.now(),
                            timestamp: new Date(cols[1]).toISOString(),
                            caseNumber: cols[2],
                            assignee: cols[3],
                            isNew: cols[4] === 'New',
                            classType: cols[5],
                            hasEn: cols[6] === 'Yes',
                            enCopies: Number(cols[7]),
                            enModes: Number(cols[8]),
                            hasCh: cols[9] === 'Yes',
                            chCopies: Number(cols[10]),
                            chModes: Number(cols[11]),
                            weight: Number(cols[12])
                        });
                    } else if (cols.length >= 10) {
                        // ËàäÊ†ºÂºèÁõ∏ÂÆπ
                        const lang = cols[6];
                        newRecords.push({
                            id: Number(cols[0]) || Date.now(),
                            timestamp: new Date(cols[1]).toISOString(),
                            caseNumber: cols[2],
                            assignee: cols[3],
                            isNew: cols[4] === 'New',
                            classType: cols[5],
                            hasEn: lang === 'EN',
                            enCopies: lang === 'EN' ? Number(cols[7]) : 0,
                            enModes: lang === 'EN' ? Number(cols[8]) : 0,
                            hasCh: lang === 'CH',
                            chCopies: lang === 'CH' ? Number(cols[7]) : 0,
                            chModes: lang === 'CH' ? Number(cols[8]) : 0,
                            weight: Number(cols[9])
                        });
                    }
                });
                return newRecords;
            }, []);

            // --- ÂàùÂßãÂåñËºâÂÖ• (localStorage + data.csv) ---
            useEffect(() => {
                const initData = async () => {
                    // 1. ÂÖàËÆÄÂèñ LocalStorage (Êú¨Âú∞Êö´Â≠ò)
                    const savedData = localStorage.getItem('emc_data');
                    let localRecords = [];
                    if (savedData) {
                        try {
                            const parsed = JSON.parse(savedData);
                            if (parsed.personnel) setPersonnel(parsed.personnel);
                            if (parsed.weights) setWeights({ ...DEFAULT_WEIGHTS, ...parsed.weights });
                            if (parsed.records) localRecords = parsed.records;
                        } catch (e) {
                            console.error("ËÆÄÂèñÂ≠òÊ™îÂ§±Êïó", e);
                        }
                    }

                    // 2. ÂòóË©¶ËÆÄÂèñÂêåÁõÆÈåÑ‰∏ãÁöÑ data.csv (‰º∫ÊúçÂô®Á´ØË≥áÊñô)
                    try {
                        // Âä†ÂÄã timestamp ÈÅøÂÖçÁÄèË¶ΩÂô®Âø´ÂèñËàäÁöÑ csv
                        const response = await fetch(`./data.csv?t=${Date.now()}`);
                        if (response.ok) {
                            const text = await response.text();
                            const serverRecords = parseCSVData(text);
                            
                            // 3. Âêà‰ΩµË≥áÊñô (Server Ë≥áÊñô + Local Ë≥áÊñôÔºåÂéªÈô§ÈáçË§á ID)
                            // ÈÄôË£°ÁöÑÈÇèËºØÊòØÔºöÂ¶ÇÊûú ID Áõ∏ÂêåÔºå‰ª• LocalStorage ÁÇ∫Ê∫ñ (ÂÅáË®≠Êú¨Âú∞ÊúâÊú™‰∏äÂÇ≥ÁöÑ‰øÆÊîπ)
                            // ‰ΩÜÈÄöÂ∏∏Âª∫Ë≠∞ Server ÁÇ∫‰∏ªÔºåÈÄôË£°ÊàëÂÄëÁ∞°ÂñÆÂÅöËÅØÈõÜ
                            const combinedRecords = [...localRecords];
                            const existingIds = new Set(localRecords.map(r => r.id));
                            
                            serverRecords.forEach(srvRec => {
                                if (!existingIds.has(srvRec.id)) {
                                    combinedRecords.push(srvRec);
                                }
                            });
                            
                            // ÈáçÊñ∞ÊéíÂ∫è
                            combinedRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            setRecords(combinedRecords);
                            console.log("ÊàêÂäüËºâÂÖ• data.csv ‰∏¶ËàáÊú¨Âú∞Ë≥áÊñôÂêà‰Ωµ");
                        } else {
                            // Â¶ÇÊûúÊ≤íÊúâ data.csvÔºåÂ∞±Âè™Áî®Êú¨Âú∞Ë≥áÊñô
                            setRecords(localRecords);
                        }
                    } catch (e) {
                        console.log("ÁÑ° data.csv ÊàñËÆÄÂèñÂ§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞Ë≥áÊñôÊ®°Âºè");
                        setRecords(localRecords);
                    }
                };

                initData();
            }, [parseCSVData]);

            // --- Ëá™ÂãïÂÑ≤Â≠òÂà∞ LocalStorage ---
            useEffect(() => {
                const dataToSave = { personnel, weights, records };
                localStorage.setItem('emc_data', JSON.stringify(dataToSave));
            }, [personnel, weights, records]);

            // --- Ë®àÁÆóÂñÆÊ°àÊ¨äÈáç (Ê†∏ÂøÉÈÇèËºØÂçáÁ¥ö) ---
            const calculateWeight = (data) => {
                let score = 0;
                // 1. Ê°à‰ª∂Âü∫Êú¨ÂàÜ
                score += data.isNew ? weights.newCase : weights.oldCase;
                score += data.classType === 'A' ? weights.classA : weights.classB;

                // 2. Ëã±ÊñáÂ†±ÂëäË®àÁÆó
                if (data.hasEn) {
                    score += weights.enReport;
                    score += (data.enCopies || 0) * weights.reportCountUnit;
                    score += (data.enModes || 0) * weights.modeCountUnit;
                }

                // 3. ‰∏≠ÊñáÂ†±ÂëäË®àÁÆó
                if (data.hasCh) {
                    score += weights.chReport;
                    score += (data.chCopies || 0) * weights.reportCountUnit;
                    score += (data.chModes || 0) * weights.modeCountUnit;
                    
                    // ÁâπÊÆäË¶èÂâáÔºö‰∏≠ÊñáÂ†±Âëä‰∏îÁÇ∫ Class B (ÁóõËã¶Âä†Êàê)
                    if (data.classType === 'B') {
                        score += (weights.chClassBBonus || 0);
                    }
                }
                return score;
            };

            // --- Áµ±Ë®àÁï∂ÂâçÊ¨äÈáç (ÂÖ¨Âπ≥ÊÄßË®àÁÆó) ---
            const workloadStats = useMemo(() => {
                const stats = {};
                personnel.forEach(p => stats[p] = 0);

                const startDate = new Date(dateRange.start);
                const endDate = new Date(dateRange.end);
                endDate.setHours(23, 59, 59, 999); // ÂåÖÂê´ÁµêÊùüÁï∂Â§©

                records.forEach(rec => {
                    const recDate = new Date(rec.timestamp);
                    if (recDate >= startDate && recDate <= endDate && personnel.includes(rec.assignee)) {
                        // Á¢∫‰øù weight ÊòØÊï∏Â≠ó
                        stats[rec.assignee] += (Number(rec.weight) || 0);
                    }
                });

                // ËΩâÁÇ∫Èô£Âàó‰∏¶ÊéíÂ∫è (Ê¨äÈáçÁî±‰ΩéÂà∞È´ò)
                return Object.entries(stats)
                    .map(([name, weight]) => ({ name, weight }))
                    .sort((a, b) => a.weight - b.weight);
            }, [records, personnel, dateRange]);

            // --- Êé®Ëñ¶‰∫∫ÈÅ∏ (Â∑•‰ΩúÈáèÊúÄÂ∞ëËÄÖ) ---
            const recommendedAssignee = workloadStats.length > 0 ? workloadStats[0].name : personnel[0];

            // --- Êèê‰∫§Ê¥æÊ°à ---
            const handleAssign = () => {
                if (!formData.caseNumber) {
                    showNotify("Ë´ãËº∏ÂÖ•Ê°àËôüÔºÅ");
                    return;
                }
                
                if (!formData.hasEn && !formData.hasCh) {
                    showNotify("Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÁ®ÆÂ†±ÂëäÈ°ûÂûãÔºà‰∏≠ÊñáÊàñËã±ÊñáÔºâÔºÅ");
                    return;
                }

                const currentWeight = calculateWeight(formData);
                const assignee = formData.manualAssignee || recommendedAssignee;

                const newRecord = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    caseNumber: formData.caseNumber,
                    assignee: assignee,
                    isNew: formData.isNew,
                    classType: formData.classType,
                    // ÂÑ≤Â≠òË©≥Á¥∞Â†±ÂëäÁµêÊßã
                    hasEn: formData.hasEn,
                    enCopies: formData.hasEn ? Number(formData.enCopies) : 0,
                    enModes: formData.hasEn ? Number(formData.enModes) : 0,
                    hasCh: formData.hasCh,
                    chCopies: formData.hasCh ? Number(formData.chCopies) : 0,
                    chModes: formData.hasCh ? Number(formData.chModes) : 0,
                    weight: currentWeight
                };

                setRecords([newRecord, ...records]);
                showNotify(`Ê°àËôü ${formData.caseNumber} Â∑≤Ê¥æÁµ¶ ${assignee} (Ê¨äÈáç: ${currentWeight})`);
                
                // ÈáçÁΩÆË°®ÂñÆÔºå‰øùÁïôÈÉ®ÂàÜË®≠ÂÆöÊñπ‰æøÈÄ£Á∫åËº∏ÂÖ• (‰æãÂ¶ÇÂ¶ÇÊûúÈÉΩÂú®ÁôºÈõôË™ûÂ†±ÂëäÔºåÂ∞±‰∏çÁî®‰∏ÄÁõ¥ÈáçÂãæ)
                setFormData(prev => ({ 
                    ...prev, 
                    caseNumber: '', 
                    manualAssignee: '' 
                }));
            };

            // --- Âà™Èô§Á¥ÄÈåÑ ---
            const handleDeleteRecord = (id) => {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁ¥ÄÈåÑÂóéÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                    setRecords(records.filter(r => r.id !== id));
                    showNotify("Á¥ÄÈåÑÂ∑≤Âà™Èô§");
                }
            };

            // --- CSV ÂåØÂá∫ (Ê†ºÂºèÊõ¥Êñ∞) ---
            const exportCSV = () => {
                const headers = [
                    "ID", "ÊôÇÈñì", "Ê°àËôü", "‰∫∫Âì°", "Êñ∞ËàäÊ°à", "Class", 
                    "Ëã±ÊñáÂ†±Âëä", "Ëã±Êñá‰ªΩÊï∏", "Ëã±ÊñáMode", 
                    "‰∏≠ÊñáÂ†±Âëä", "‰∏≠Êñá‰ªΩÊï∏", "‰∏≠ÊñáMode", 
                    "Á∏ΩÊ¨äÈáç"
                ];
                
                const rows = records.map(r => {
                    // ËôïÁêÜËàäË≥áÊñôÁõ∏ÂÆπÊÄß
                    const isOldFormat = r.hasEn === undefined;
                    const hasEn = isOldFormat ? (r.lang === 'EN') : r.hasEn;
                    const enCopies = isOldFormat ? (r.lang === 'EN' ? r.reportCount : 0) : r.enCopies;
                    const enModes = isOldFormat ? (r.lang === 'EN' ? r.modeCount : 0) : r.enModes;
                    
                    const hasCh = isOldFormat ? (r.lang === 'CH') : r.hasCh;
                    const chCopies = isOldFormat ? (r.lang === 'CH' ? r.reportCount : 0) : r.chCopies;
                    const chModes = isOldFormat ? (r.lang === 'CH' ? r.modeCount : 0) : r.chModes;

                    return [
                        r.id,
                        new Date(r.timestamp).toLocaleString(),
                        r.caseNumber,
                        r.assignee,
                        r.isNew ? 'New' : 'Old',
                        r.classType,
                        hasEn ? 'Yes' : 'No', enCopies, enModes,
                        hasCh ? 'Yes' : 'No', chCopies, chModes,
                        r.weight
                    ];
                });

                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                // ÈáçË¶ÅÔºöÈÄôË£°ÁöÑÊ™îÂêçË®≠ÁÇ∫ data.csv Êñπ‰æø‰ΩøÁî®ËÄÖÁõ¥Êé•Ë¶ÜËìã
                link.setAttribute("download", "data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotify("CSV ‰∏ãËºâÊàêÂäüÔºÅË´ãÂ∞áÊ≠§Ê™îÊ°à‰∏äÂÇ≥Ëá≥ GitHub Ë¶ÜËìãÂéüÊ™î„ÄÇ");
            };

            // --- CSV ÂåØÂÖ• (‰ΩøÁî®ÂÖ±Áî®Ëß£ÊûêÈÇèËºØ) ---
            const importCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const newRecords = parseCSVData(text);

                    setRecords(prev => {
                        const existingIds = new Set(prev.map(r => r.id));
                        const uniqueNew = newRecords.filter(r => !existingIds.has(r.id));
                        return [...uniqueNew, ...prev].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    });
                    showNotify(`ÊàêÂäüÂåØÂÖ• ${newRecords.length} Á≠ÜË≥áÊñô`);
                };
                reader.readAsText(file);
                event.target.value = ''; 
            };

            // --- ËºîÂä©ÂáΩÂºèÔºöÊ∏≤ÊüìÊ≠∑Âè≤Á¥ÄÈåÑÁöÑÂ†±ÂëäË©≥ÊÉÖ ---
            const renderReportDetail = (rec) => {
                // ËàäÊ†ºÂºèÁõ∏ÂÆπ
                if (rec.hasEn === undefined) {
                    return (
                        <div className="flex gap-1">
                            <span className={`text-xs px-2 py-0.5 rounded ${rec.lang === 'EN' ? 'bg-indigo-100 text-indigo-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                {rec.lang} ({rec.reportCount}‰ªΩ/{rec.modeCount}M)
                            </span>
                        </div>
                    );
                }

                // Êñ∞Ê†ºÂºè
                return (
                    <div className="flex flex-col gap-1">
                        {rec.hasEn && (
                            <span className="text-xs bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100 w-fit">
                                EN: {rec.enCopies}‰ªΩ / {rec.enModes}M
                            </span>
                        )}
                        {rec.hasCh && (
                            <span className="text-xs bg-emerald-50 text-emerald-700 px-1.5 py-0.5 rounded border border-emerald-100 w-fit">
                                CH: {rec.chCopies}‰ªΩ / {rec.chModes}M
                            </span>
                        )}
                    </div>
                );
            };

            // --- UI Components ---

            const TabButton = ({ id, label, icon: Icon }) => (
                <button 
                    onClick={() => setActiveTab(id)}
                    className={`flex items-center gap-2 px-4 py-3 font-medium transition-all ${activeTab === id ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}
                >
                    <Icon size={18} />
                    {label}
                </button>
            );

            return (
                <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans">
                    <div className="max-w-5xl mx-auto">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                                    <Calculator className="text-blue-600" /> EMC Ê¨äÈáçÊ¥æÊ°àÂ§ßÂ∏´
                                </h1>
                                <p className="text-slate-500 mt-1">ÂÖ¨Âπ≥„ÄÅÂÖ¨Ê≠£„ÄÅÂÖ¨ÈñãÔºàËá™ÂãïËÆÄÂèñ data.csvÔºâ</p>
                            </div>
                            <div className="text-right hidden md:block">
                                <div className="text-sm text-slate-400">Á≥ªÁµ±ÊôÇÈñì</div>
                                <div className="font-mono text-lg font-bold text-slate-700">{new Date().toLocaleDateString()}</div>
                            </div>
                        </div>

                        {/* Navigation */}
                        <div className="bg-white rounded-t-xl shadow-sm border-b border-slate-200 flex overflow-x-auto">
                            <TabButton id="dashboard" label="Ê¥æÊ°à‰∏≠ÂøÉ" icon={PieChart} />
                            <TabButton id="history" label="Ê≠∑Âè≤Á¥ÄÈåÑ" icon={History} />
                            <TabButton id="settings" label="Ë®≠ÂÆöËàáÊ¨äÈáç" icon={Settings} />
                            <TabButton id="data" label="Ë≥áÊñôÁÆ°ÁêÜ" icon={Save} />
                        </div>

                        {/* Main Content Area */}
                        <div className="bg-white rounded-b-xl shadow-lg p-6 min-h-[500px]">
                            
                            {/* 1. Dashboard Tab */}
                            {activeTab === 'dashboard' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    {/* Left: Input Form */}
                                    <div className="lg:col-span-2 space-y-6">
                                        <div className="bg-blue-50 p-6 rounded-xl border border-blue-100">
                                            <h2 className="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2">
                                                <Edit3 size={20}/> Êñ∞Â¢ûÊ¥æÊ°à
                                            </h2>
                                            
                                            {/* Ê°àËôüËàáÈ°ûÂûã */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">Ê°àËôü</label>
                                                    <input 
                                                        type="text" 
                                                        value={formData.caseNumber}
                                                        onChange={(e) => setFormData({...formData, caseNumber: e.target.value})}
                                                        placeholder="Ëº∏ÂÖ• EMC Ê°àËôü"
                                                        className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">Ê°à‰ª∂È°ûÂûã & Á≠âÁ¥ö</label>
                                                    <div className="flex gap-2">
                                                         <select 
                                                            value={formData.isNew ? 'New' : 'Old'}
                                                            onChange={(e) => setFormData({...formData, isNew: e.target.value === 'New'})}
                                                            className="flex-1 p-2 border border-slate-300 rounded-lg bg-white"
                                                        >
                                                            <option value="New">Êñ∞Ê°à (New)</option>
                                                            <option value="Old">ËàäÊ°à (Old)</option>
                                                        </select>
                                                        <select 
                                                            value={formData.classType}
                                                            onChange={(e) => setFormData({...formData, classType: e.target.value})}
                                                            className="flex-1 p-2 border border-slate-300 rounded-lg bg-white"
                                                        >
                                                            
                                                            <option value="A">Class A</option>
                                                            <option value="B">Class B</option>
                                                            
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <hr className="border-blue-200 my-4" />
                                            
                                            {/* Â†±ÂëäË®≠ÂÆöÂçÄÂüü */}
                                            <div className="mb-2">
                                                <label className="block text-sm font-medium text-slate-700 mb-3">Â†±ÂëäÈ°ûÂûãËàáÊï∏ÈáèË®≠ÂÆö</label>
                                                
                                                {/* Ëã±ÊñáÂ†±ÂëäË®≠ÂÆö */}
                                                <label className={`block p-3 rounded-lg border mb-3 transition-all cursor-pointer ${formData.hasEn ? 'bg-white border-blue-300 shadow-sm' : 'bg-slate-50 border-slate-200 opacity-80'}`}>
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <input 
                                                            type="checkbox"
                                                            checked={formData.hasEn}
                                                            onChange={(e) => setFormData({...formData, hasEn: e.target.checked})}
                                                            className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300"
                                                        />
                                                        <span className={`text-sm font-bold ${formData.hasEn ? 'text-blue-700' : 'text-slate-500'}`}>
                                                            Ëã±ÊñáÂ†±Âëä (English)
                                                        </span>
                                                    </div>
                                                    
                                                    {formData.hasEn && (
                                                        <div className="flex gap-4 ml-8" onClick={(e) => e.stopPropagation()}>
                                                            <div className="flex-1 flex items-center gap-2">
                                                                <span className="text-xs text-slate-500">‰ªΩÊï∏:</span>
                                                                <input 
                                                                    type="number" min="1"
                                                                    value={formData.enCopies}
                                                                    onChange={(e) => setFormData({...formData, enCopies: e.target.value})}
                                                                    className="w-full p-1.5 border border-slate-300 rounded text-sm"
                                                                />
                                                            </div>
                                                            <div className="flex-1 flex items-center gap-2">
                                                                <span className="text-xs text-slate-500">ModeÊï∏:</span>
                                                                <input 
                                                                    type="number" min="1"
                                                                    value={formData.enModes}
                                                                    onChange={(e) => setFormData({...formData, enModes: e.target.value})}
                                                                    className="w-full p-1.5 border border-slate-300 rounded text-sm"
                                                                />
                                                            </div>
                                                        </div>
                                                    )}
                                                </label>

                                                {/* ‰∏≠ÊñáÂ†±ÂëäË®≠ÂÆö */}
                                                <label className={`block p-3 rounded-lg border transition-all cursor-pointer ${formData.hasCh ? 'bg-white border-emerald-300 shadow-sm' : 'bg-slate-50 border-slate-200 opacity-80'}`}>
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <input 
                                                            type="checkbox"
                                                            checked={formData.hasCh}
                                                            onChange={(e) => setFormData({...formData, hasCh: e.target.checked})}
                                                            className="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500 border-gray-300"
                                                        />
                                                        <span className={`text-sm font-bold ${formData.hasCh ? 'text-emerald-700' : 'text-slate-500'}`}>
                                                            ‰∏≠ÊñáÂ†±Âëä (Chinese)
                                                        </span>
                                                        {formData.hasCh && formData.classType === 'B' && (
                                                            <span className="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-medium">
                                                                üî• ÁóõËã¶Âä†ÊàêÂ∑≤ÂïüÂãï
                                                            </span>
                                                        )}
                                                    </div>
                                                    
                                                    {formData.hasCh && (
                                                        <div className="flex gap-4 ml-8" onClick={(e) => e.stopPropagation()}>
                                                            <div className="flex-1 flex items-center gap-2">
                                                                <span className="text-xs text-slate-500">‰ªΩÊï∏:</span>
                                                                <input 
                                                                    type="number" min="1"
                                                                    value={formData.chCopies}
                                                                    onChange={(e) => setFormData({...formData, chCopies: e.target.value})}
                                                                    className="w-full p-1.5 border border-slate-300 rounded text-sm"
                                                                />
                                                            </div>
                                                            <div className="flex-1 flex items-center gap-2">
                                                                <span className="text-xs text-slate-500">ModeÊï∏:</span>
                                                                <input 
                                                                    type="number" min="1"
                                                                    value={formData.chModes}
                                                                    onChange={(e) => setFormData({...formData, chModes: e.target.value})}
                                                                    className="w-full p-1.5 border border-slate-300 rounded text-sm"
                                                                />
                                                            </div>
                                                        </div>
                                                    )}
                                                </label>
                                            </div>

                                            {/* Dynamic Weight Preview */}
                                            <div className="bg-white/60 p-3 rounded-lg border border-blue-100 mb-6 flex justify-between items-center">
                                                <span className="text-sm text-slate-600">Êú¨Ê°àÈ†ê‰º∞Ê¨äÈáçÔºö</span>
                                                <span className="text-2xl font-bold text-blue-600">{calculateWeight(formData)}</span>
                                            </div>

                                            <div className="mb-6">
                                                <label className="block text-sm font-medium text-slate-700 mb-2">
                                                    ÊåáÊ¥æ‰∫∫Âì° 
                                                    <span className="ml-2 text-xs font-normal text-slate-500">(Á≥ªÁµ±Âª∫Ë≠∞: <strong className="text-green-600">{recommendedAssignee}</strong>)</span>
                                                </label>
                                                <div className="flex flex-wrap gap-2">
                                                    {personnel.map(p => (
                                                        <button
                                                            key={p}
                                                            onClick={() => setFormData({...formData, manualAssignee: p})}
                                                            className={`px-4 py-2 rounded-full text-sm font-medium border transition-all ${
                                                                (formData.manualAssignee || recommendedAssignee) === p
                                                                    ? 'bg-blue-600 text-white border-blue-600 ring-2 ring-blue-200'
                                                                    : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300'
                                                            }`}
                                                        >
                                                            {p}
                                                            {recommendedAssignee === p && !formData.manualAssignee && <span className="ml-1 text-xs opacity-80">‚òÖ</span>}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <button 
                                                onClick={handleAssign}
                                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-md active:scale-[0.98]"
                                            >
                                                Á¢∫Ë™çÊ¥æÊ°à
                                            </button>
                                        </div>
                                    </div>

                                    {/* Right: Stats */}
                                    <div className="space-y-6">
                                        <div className="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                                            <h3 className="font-bold text-slate-800 mb-4">Áï∂ÂâçÂ∑•‰ΩúÈáèÁµ±Ë®à</h3>
                                            <div className="text-xs text-slate-500 mb-4 flex gap-2 items-center">
                                                <input 
                                                    type="date" 
                                                    value={dateRange.start}
                                                    onChange={(e) => setDateRange({...dateRange, start: e.target.value})}
                                                    className="border rounded px-1"
                                                />
                                                <ArrowRight size={12}/>
                                                <input 
                                                    type="date" 
                                                    value={dateRange.end}
                                                    onChange={(e) => setDateRange({...dateRange, end: e.target.value})}
                                                    className="border rounded px-1"
                                                />
                                            </div>
                                            
                                            <div className="space-y-4">
                                                {workloadStats.map((stat, idx) => (
                                                    <div key={stat.name} className="relative">
                                                        <div className="flex justify-between text-sm mb-1">
                                                            <span className={`font-medium ${idx === 0 ? 'text-green-600' : 'text-slate-700'}`}>
                                                                {stat.name} {idx === 0 && '(ÊúÄÈñí)'}
                                                            </span>
                                                            <span className="font-bold text-slate-600">{stat.weight} pts</span>
                                                        </div>
                                                        <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                                            <div 
                                                                className={`h-2.5 rounded-full ${idx === 0 ? 'bg-green-500' : 'bg-blue-400'}`} 
                                                                style={{ width: `${Math.min((stat.weight / (workloadStats[workloadStats.length-1].weight || 1)) * 100, 100)}%` }}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        <div className="bg-orange-50 border border-orange-100 rounded-xl p-4 text-sm text-orange-800">
                                            <p className="font-bold mb-1">üí° Ê¥æÊ°àÂ∞èÊèêÁ§∫</p>
                                            <p>Ëã•ÂêåÊôÇÂãæÈÅ∏‰∏≠Ëã±ÊñáÂ†±ÂëäÔºåÊ¨äÈáçÊúÉÁñäÂä†Ë®àÁÆó„ÄÇ</p>
                                            <p className="mt-1">Class B ÁöÑ‰∏≠ÊñáÂ†±Âëä‰ªç‰∫´Êúâ {weights.chClassBBonus} ÂàÜÁöÑÁâπÂà•Âä†Êàê„ÄÇ</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* 2. History Tab */}
                            {activeTab === 'history' && (
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-bold text-slate-800">Ê≠∑Âè≤Ê¥æÊ°àÁ¥ÄÈåÑ</h2>
                                        <span className="text-sm text-slate-500">ÂÖ± {records.length} Á≠Ü</span>
                                    </div>
                                    <div className="overflow-x-auto border rounded-lg">
                                        <table className="w-full text-sm text-left text-slate-600">
                                            <thead className="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                                                <tr>
                                                    <th className="px-4 py-3">ÊôÇÈñì</th>
                                                    <th className="px-4 py-3">Ê°àËôü</th>
                                                    <th className="px-4 py-3">‰∫∫Âì°</th>
                                                    <th className="px-4 py-3">È°ûÂûã/Á≠âÁ¥ö</th>
                                                    <th className="px-4 py-3">Â†±ÂëäË©≥ÊÉÖ</th>
                                                    <th className="px-4 py-3 text-right">Ê¨äÈáç</th>
                                                    <th className="px-4 py-3 text-center">Êìç‰Ωú</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {records.map(rec => (
                                                    <tr key={rec.id} className="bg-white border-b hover:bg-slate-50">
                                                        <td className="px-4 py-3">{new Date(rec.timestamp).toLocaleDateString()}</td>
                                                        <td className="px-4 py-3 font-medium text-slate-900">{rec.caseNumber}</td>
                                                        <td className="px-4 py-3">
                                                            <span className="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">{rec.assignee}</span>
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            {rec.isNew ? 'New' : 'Old'} / {rec.classType}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            {renderReportDetail(rec)}
                                                        </td>
                                                        <td className="px-4 py-3 text-right font-bold">{rec.weight}</td>
                                                        <td className="px-4 py-3 text-center">
                                                            <button 
                                                                onClick={() => handleDeleteRecord(rec.id)}
                                                                className="text-red-500 hover:text-red-700 p-1"
                                                            >
                                                                <Trash2 size={16} />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {records.length === 0 && (
                                                    <tr>
                                                        <td colSpan="8" className="px-4 py-8 text-center text-slate-400">Â∞öÁÑ°Á¥ÄÈåÑ</td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* 3. Settings Tab */}
                            {activeTab === 'settings' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    {/* Personnel Settings */}
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                            <UserPlus size={20}/> ‰∫∫Âì°ÁÆ°ÁêÜ
                                        </h2>
                                        <div className="bg-white border rounded-xl p-4 space-y-3">
                                            {personnel.map(p => (
                                                <div key={p} className="flex justify-between items-center p-2 bg-slate-50 rounded-lg">
                                                    <span>{p}</span>
                                                    <button 
                                                        onClick={() => setPersonnel(personnel.filter(name => name !== p))}
                                                        className="text-red-400 hover:text-red-600"
                                                        disabled={personnel.length <= 1}
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                </div>
                                            ))}
                                            <div className="flex gap-2 mt-4 pt-4 border-t">
                                                <input 
                                                    type="text" 
                                                    id="newPerson" 
                                                    placeholder="Ëº∏ÂÖ•Êñ∞ÂêçÂ≠ó"
                                                    className="flex-1 border rounded px-2 text-sm"
                                                    onKeyDown={(e) => {
                                                        if(e.key === 'Enter') {
                                                            const val = e.target.value.trim();
                                                            if(val && !personnel.includes(val)) {
                                                                setPersonnel([...personnel, val]);
                                                                e.target.value = '';
                                                            }
                                                        }
                                                    }}
                                                />
                                                <button 
                                                    onClick={() => {
                                                        const input = document.getElementById('newPerson');
                                                        const val = input.value.trim();
                                                        if(val && !personnel.includes(val)) {
                                                            setPersonnel([...personnel, val]);
                                                            input.value = '';
                                                        }
                                                    }}
                                                    className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                                                >
                                                    Êñ∞Â¢û
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Weight Settings */}
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                            <Settings size={20}/> Ê¨äÈáçÂèÉÊï∏Ë®≠ÂÆö
                                        </h2>
                                        <div className="bg-white border rounded-xl p-4 grid grid-cols-1 gap-4">
                                            {[
                                                { k: 'newCase', l: 'Êñ∞Ê°à (New Case)' },
                                                { k: 'oldCase', l: 'ËàäÊ°à (Old Case)' },
                                                { k: 'classA', l: 'Class A' },
                                                { k: 'classB', l: 'Class B' },
                                                { k: 'enReport', l: 'Ëã±ÊñáÂ†±ÂëäÂü∫Êú¨ÂàÜ' },
                                                { k: 'chReport', l: '‰∏≠ÊñáÂ†±ÂëäÂü∫Êú¨ÂàÜ' },
                                                { k: 'reportCountUnit', l: 'ÊØè‰ªΩÂ†±ÂëäÂä†Ê¨ä' },
                                                { k: 'modeCountUnit', l: 'ÊØèÂÄã Mode Âä†Ê¨ä' },
                                                { k: 'chClassBBonus', l: '‰∏≠Êñá Class B ÁâπÂà•Âä†Ê¨ä' },
                                            ].map(item => (
                                                <div key={item.k} className="flex justify-between items-center">
                                                    <label className="text-sm text-slate-600">{item.l}</label>
                                                    <input 
                                                        type="number" 
                                                        value={weights[item.k]}
                                                        onChange={(e) => setWeights({...weights, [item.k]: Number(e.target.value)})}
                                                        className="w-20 border rounded px-2 py-1 text-right focus:ring-2 focus:ring-blue-500 outline-none"
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* 4. Data Tab */}
                            {activeTab === 'data' && (
                                <div className="flex flex-col items-center justify-center py-10 space-y-6">
                                    <div className="text-center space-y-2">
                                        <h2 className="text-2xl font-bold text-slate-800">Ë≥áÊñôÂÇô‰ªΩËàáÈÇÑÂéü</h2>
                                        <p className="text-slate-500">ÊâÄÊúâÁöÑÁ¥ÄÈåÑÈÉΩÂ≠òÂú®Ê≠§ÁÄèË¶ΩÂô®‰∏≠ÔºåË´ãÂÆöÊúü‰∏ãËºâ CSV ÂÇô‰ªΩ„ÄÇ</p>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                                        <div className="bg-blue-50 border border-blue-200 p-6 rounded-xl text-center hover:shadow-md transition-shadow">
                                            <Save size={48} className="mx-auto text-blue-600 mb-4" />
                                            <h3 className="font-bold text-lg mb-2">ÂåØÂá∫ CSV</h3>
                                            <p className="text-sm text-slate-600 mb-4">
                                                ÈªûÊìä‰∏ãËºâÊúÄÊñ∞ÁöÑ CSV Ê™îÔºåË´ãÂ∞áÊ≠§Ê™îÊ°à<b>‰∏äÂÇ≥‰∏¶Ë¶ÜËìã GitHub Â∞àÊ°à</b>‰∏≠ÁöÑ data.csvÔºå‰ª•ÂÆåÊàêË≥áÊñôÂÑ≤Â≠ò„ÄÇ
                                            </p>
                                            <button 
                                                onClick={exportCSV}
                                                className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-medium"
                                            >
                                                ‰∏ãËºâ data.csv (Ë¶ÜËìãÁî®)
                                            </button>
                                        </div>

                                        <div className="bg-emerald-50 border border-emerald-200 p-6 rounded-xl text-center hover:shadow-md transition-shadow">
                                            <Upload size={48} className="mx-auto text-emerald-600 mb-4" />
                                            <h3 className="font-bold text-lg mb-2">ÊâãÂãïÂåØÂÖ• CSV</h3>
                                            <p className="text-sm text-slate-600 mb-4">Ëã•Ëá™ÂãïËÆÄÂèñÂ§±ÊïóÔºåÂèØÁî±Ê≠§ÊâãÂãïËÆÄÂèñ„ÄÇ</p>
                                            <label className="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 font-medium cursor-pointer inline-block">
                                                ÈÅ∏ÊìáÊ™îÊ°à
                                                <input type="file" accept=".csv" onChange={importCSV} className="hidden" />
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Notification Toast */}
                        {notification && (
                            <div className="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl animate-bounce">
                                {notification}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Á®ãÂºèÂÖ•Âè£Èªû (Entry Point) ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
