import React, { useState, useMemo, useEffect } from 'react';
import { 
  PlusCircle, 
  History, 
  BarChart3, 
  Settings, 
  ChevronRight, 
  CheckCircle2, 
  AlertCircle,
  UserPlus,
  Zap,
  MousePointer2,
  Download
} from 'lucide-react';

// Firebase ç›¸é—œå¼•ç”¨
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  addDoc, 
  onSnapshot, 
  query, 
  updateDoc,
  getDocs,
  writeBatch
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// --- Firebase åˆå§‹åŒ– ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'emc-dispatch-pro';

const App = () => {
  const [user, setUser] = useState(null);
  const [members, setMembers] = useState([]);
  const [history, setHistory] = useState([]);
  const [newMemberName, setNewMemberName] = useState('');
  const [isSyncing, setIsSyncing] = useState(true);
  
  // --- æ¬Šé‡è¨­å®š ---
  const [weights, setWeights] = useState({
    newCase: 1.5,
    oldCase: 1.0,
    enReport: 2.0,
    cnReport: 1.5,
    classB_CN_Extra: 1.3,
    copyWeight: 0.5,
    modeWeight: 0.8
  });

  // --- è¡¨å–®ç‹€æ…‹ ---
  const [formData, setFormData] = useState({
    caseType: 'new',
    emcClass: 'ClassB',
    enCopies: 0,
    enModes: 0,
    cnCopies: 0,
    cnModes: 0,
  });

  const [selectedMemberId, setSelectedMemberId] = useState(null);

  // --- 1. Firebase èº«ä»½é©—è­‰ (Rule 3) ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- 2. æ•¸æ“šç›£è½èˆ‡åˆå§‹åŒ– (Rule 1 & 2) ---
  useEffect(() => {
    if (!user) return;

    // ç›£è½æˆå“¡åˆ—è¡¨
    const membersRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
    const unsubscribeMembers = onSnapshot(membersRef, (snapshot) => {
      const membersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // å¦‚æœè³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œåˆå§‹åŒ–é è¨­åå–®
      if (membersData.length === 0) {
        const defaultNames = ['Anita', 'Anny', 'Rita', 'Peggy'];
        defaultNames.forEach(async (name) => {
          await addDoc(membersRef, { name, totalScore: 0 });
        });
      } else {
        setMembers(membersData);
      }
      setIsSyncing(false);
    }, (err) => console.error("Members sync error:", err));

    // ç›£è½æ­·å²ç´€éŒ„
    const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
    const unsubscribeHistory = onSnapshot(historyRef, (snapshot) => {
      const historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // æ ¹æ“šæ™‚é–“æ’åºï¼ˆåœ¨å‰ç«¯æ’åºä»¥ç¬¦åˆ Rule 2ï¼‰
      const sortedHistory = historyData.sort((a, b) => b.timestamp - a.timestamp);
      setHistory(sortedHistory);
    }, (err) => console.error("History sync error:", err));

    return () => {
      unsubscribeMembers();
      unsubscribeHistory();
    };
  }, [user]);

  // --- è¨ˆç®—é‚è¼¯ ---
  const calculateCaseScore = (data) => {
    const enBase = (data.enCopies * weights.copyWeight) + (data.enModes * weights.modeWeight);
    const enTotal = enBase * weights.enReport;
    const cnBase = (data.cnCopies * weights.copyWeight) + (data.cnModes * weights.modeWeight);
    let cnMultiplier = weights.cnReport;
    if (data.emcClass === 'ClassB') cnMultiplier *= weights.classB_CN_Extra;
    const cnTotal = cnBase * cnMultiplier;
    const caseMultiplier = data.caseType === 'new' ? weights.newCase : weights.oldCase;
    return parseFloat(((enTotal + cnTotal) * caseMultiplier).toFixed(2));
  };

  const currentCaseScore = useMemo(() => calculateCaseScore(formData), [formData, weights]);

  // ç³»çµ±å»ºè­°äººé¸
  const recommendedMember = useMemo(() => {
    if (members.length === 0) return null;
    return [...members].sort((a, b) => a.totalScore - b.totalScore)[0];
  }, [members]);

  // è‡ªå‹•è·Ÿéš¨å»ºè­°
  useEffect(() => {
    if (recommendedMember && !selectedMemberId) {
      setSelectedMemberId(recommendedMember.id);
    }
  }, [recommendedMember]);

  // --- å‹•ä½œè™•ç† ---
  const addMember = async () => {
    if (!newMemberName.trim() || !user) return;
    const membersRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
    await addDoc(membersRef, { name: newMemberName, totalScore: 0 });
    setNewMemberName('');
  };

  const dispatchCase = async () => {
    const targetMember = members.find(m => m.id === selectedMemberId);
    if (!targetMember || currentCaseScore <= 0 || !user) return;

    const score = currentCaseScore;
    const now = new Date();

    // æ›´æ–° Firestore ä¸­çš„æˆå“¡åˆ†æ•¸
    const memberDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', targetMember.id);
    await updateDoc(memberDocRef, {
      totalScore: parseFloat((targetMember.totalScore + score).toFixed(2))
    });

    // æ–°å¢æ­·å²ç´€éŒ„åˆ° Firestore
    const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
    await addDoc(historyRef, {
      assignee: targetMember.name,
      score,
      details: { ...formData },
      timestamp: now.getTime(),
      timeString: now.toLocaleString()
    });

    // é‡ç½®
    setFormData({ ...formData, enCopies: 0, enModes: 0, cnCopies: 0, cnModes: 0 });
    setSelectedMemberId(null); 
  };

  // --- åŒ¯å‡º Excel (CSV) åŠŸèƒ½ ---
  const exportToExcel = () => {
    if (history.length === 0) return;

    // CSV è¡¨é ­
    const headers = ["æ™‚é–“", "æ´¾æ¡ˆäººé¸", "æ¡ˆä»¶ç©åˆ†", "æ¡ˆä»¶é¡å‹", "æ¸¬è©¦ç­‰ç´š", "è‹±æ–‡ä»½æ•¸", "è‹±æ–‡MODE", "ä¸­æ–‡ä»½æ•¸", "ä¸­æ–‡MODE"];
    
    // è½‰æ›è³‡æ–™è¡Œ
    const rows = history.map(item => [
      `"${item.timeString}"`,
      `"${item.assignee}"`,
      item.score,
      `"${item.details.caseType === 'new' ? 'æ–°æ¡ˆ' : 'èˆŠæ¡ˆ'}"`,
      `"${item.details.emcClass}"`,
      item.details.enCopies,
      item.details.enModes,
      item.details.cnCopies,
      item.details.cnModes
    ]);

    // åˆä½µç‚º CSV å­—ä¸² (ä½¿ç”¨ \ufeff è§£æ±º Excel é–‹å•Ÿä¸­æ–‡äº‚ç¢¼)
    const csvContent = "\ufeff" + [headers, ...rows].map(e => e.join(",")).join("\n");
    
    // è§¸ç™¼ä¸‹è¼‰
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `EMC_Dispatch_History_${new Date().toLocaleDateString()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  if (isSyncing) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50">
        <div className="text-center">
          <Zap className="w-12 h-12 text-blue-600 animate-pulse mx-auto mb-4" />
          <p className="text-slate-500 font-medium">æ­£åœ¨é€£ç·šè‡³ EMC å¯¦é©—å®¤è³‡æ–™åº«...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900">
      <div className="max-w-6xl mx-auto">
        
        {/* Header */}
        <header className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <div>
            <h1 className="text-3xl font-bold text-blue-600 flex items-center gap-2">
              <Zap className="w-8 h-8 fill-blue-600" />
              EMC æ´¾æ¡ˆå¤§å¸« Pro <span className="text-xs font-mono bg-blue-600 text-white px-2 py-1 rounded">Cloud v3.0</span>
            </h1>
            <p className="text-slate-500 mt-1 italic">é›²ç«¯å„²å­˜å·²å•Ÿå‹•ï¼šæ•¸æ“šå°‡è·¨è£ç½®æ°¸ä¹…å»¶çºŒã€‚</p>
          </div>
          
          <div className="flex items-center gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
            <input 
              type="text" 
              placeholder="æ–°å¢å·¥ç¨‹å¸«..." 
              className="px-3 py-2 outline-none text-sm"
              value={newMemberName}
              onChange={(e) => setNewMemberName(e.target.value)}
            />
            <button onClick={addMember} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition-colors">
              <UserPlus className="w-5 h-5" />
            </button>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* Left Column */}
          <div className="lg:col-span-2 space-y-6">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="bg-blue-50 px-6 py-4 border-b border-blue-100 flex justify-between items-center">
                <h2 className="font-semibold flex items-center gap-2 text-blue-800">
                  <PlusCircle className="w-5 h-5" />
                  EMC æ¡ˆä»¶è³‡è¨ŠéŒ„å…¥
                </h2>
                <div className="flex gap-2">
                  <span className={`px-2 py-1 rounded text-[10px] font-bold ${formData.caseType === 'new' ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-600'}`}>
                    {formData.caseType === 'new' ? 'æ–°æ¡ˆ' : 'èˆŠæ¡ˆ'}
                  </span>
                  <span className={`px-2 py-1 rounded text-[10px] font-bold ${formData.emcClass === 'ClassB' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'}`}>
                    {formData.emcClass}
                  </span>
                </div>
              </div>
              
              <div className="p-6 space-y-6">
                {/* æ¡ˆä»¶èˆ‡ç­‰ç´šåˆ‡æ› */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="text-xs font-bold text-slate-400 uppercase">Case Type</label>
                    <div className="flex bg-slate-100 p-1 rounded-xl">
                      {['new', 'old'].map(type => (
                        <button 
                          key={type}
                          onClick={() => setFormData({...formData, caseType: type})}
                          className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${formData.caseType === type ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}
                        >{type === 'new' ? 'æ–°æ¡ˆ' : 'èˆŠæ¡ˆ'}</button>
                      ))}
                    </div>
                  </div>
                  <div className="space-y-2">
                    <label className="text-xs font-bold text-slate-400 uppercase">Limit Class</label>
                    <div className="flex bg-slate-100 p-1 rounded-xl">
                      {['ClassA', 'ClassB'].map(cls => (
                        <button 
                          key={cls}
                          onClick={() => setFormData({...formData, emcClass: cls})}
                          className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${formData.emcClass === cls ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}
                        >{cls}</button>
                      ))}
                    </div>
                  </div>
                </div>

                {/* æ•¸æ“šè¼¸å…¥ */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="p-4 rounded-xl bg-blue-50/50 border border-blue-100 space-y-4">
                    <h3 className="font-bold text-blue-700 flex justify-between items-center text-sm">
                      <span>ğŸ‡ºğŸ‡¸ è‹±æ–‡å ±å‘Š (EN)</span>
                    </h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 block mb-1">COPIES</label>
                        <input type="number" className="w-full p-2 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-blue-400" value={formData.enCopies} onChange={(e) => setFormData({...formData, enCopies: parseInt(e.target.value) || 0})} />
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 block mb-1">MODES</label>
                        <input type="number" className="w-full p-2 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-blue-400" value={formData.enModes} onChange={(e) => setFormData({...formData, enModes: parseInt(e.target.value) || 0})} />
                      </div>
                    </div>
                  </div>

                  <div className={`p-4 rounded-xl border space-y-4 transition-colors ${formData.emcClass === 'ClassB' ? 'bg-purple-50/50 border-purple-100' : 'bg-emerald-50/50 border-emerald-100'}`}>
                    <h3 className={`font-bold flex justify-between items-center text-sm ${formData.emcClass === 'ClassB' ? 'text-purple-700' : 'text-emerald-700'}`}>
                      <span>ğŸ‡¨ğŸ‡³ ä¸­æ–‡å ±å‘Š (CN)</span>
                    </h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 block mb-1">COPIES</label>
                        <input type="number" className="w-full p-2 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-purple-400" value={formData.cnCopies} onChange={(e) => setFormData({...formData, cnCopies: parseInt(e.target.value) || 0})} />
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 block mb-1">MODES</label>
                        <input type="number" className="w-full p-2 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-purple-400" value={formData.cnModes} onChange={(e) => setFormData({...formData, cnModes: parseInt(e.target.value) || 0})} />
                      </div>
                    </div>
                  </div>
                </div>

                {/* æŒ‡æ´¾äººé¸ */}
                <div className="pt-2">
                  <label className="text-xs font-bold text-slate-400 uppercase mb-3 block flex items-center gap-1">
                    <MousePointer2 className="w-3 h-3" /> æŒ‡æ´¾å°è±¡ (é è¨­ç‚ºå»ºè­°äººé¸)
                  </label>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                    {members.map(m => {
                      const isRecommended = m.id === recommendedMember?.id;
                      const isSelected = m.id === selectedMemberId;
                      return (
                        <button
                          key={m.id}
                          onClick={() => setSelectedMemberId(m.id)}
                          className={`relative p-3 rounded-xl border-2 text-left transition-all group ${
                            isSelected ? 'border-blue-600 bg-blue-50' : 'border-slate-100 hover:border-slate-200'
                          }`}
                        >
                          <p className={`text-sm font-bold ${isSelected ? 'text-blue-700' : 'text-slate-600'}`}>{m.name}</p>
                          <p className="text-[10px] text-slate-400 font-mono">{m.totalScore} pt</p>
                          {isRecommended && (
                            <span className="absolute -top-2 -right-1 bg-green-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold shadow-sm">æ¨è–¦</span>
                          )}
                          {isSelected && <CheckCircle2 className="absolute bottom-2 right-2 w-4 h-4 text-blue-600" />}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* çµç®—å€ */}
                <div className="pt-6 border-t border-slate-100 flex items-center justify-between">
                  <div>
                    <span className="text-xs text-slate-500 block uppercase font-bold tracking-tight">Case Complexity</span>
                    <span className="text-3xl font-black text-blue-600">{currentCaseScore}</span>
                  </div>
                  <div className="text-right">
                    <button 
                      onClick={dispatchCase}
                      disabled={!selectedMemberId || currentCaseScore <= 0}
                      className="px-8 py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 disabled:bg-slate-300 disabled:shadow-none transition-all flex items-center gap-2"
                    >
                      ç¢ºèªæ´¾æ¡ˆçµ¦ {members.find(m => m.id === selectedMemberId)?.name} <ChevronRight className="w-5 h-5" />
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* History */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h2 className="font-semibold flex items-center gap-2 text-slate-700">
                  <History className="w-5 h-5" />æ­·å²ç´€éŒ„
                </h2>
                <button 
                  onClick={exportToExcel}
                  disabled={history.length === 0}
                  className="text-xs font-bold text-blue-600 flex items-center gap-1 hover:bg-blue-50 px-3 py-1.5 rounded-lg transition-colors border border-blue-100 disabled:opacity-50"
                >
                  <Download className="w-3.5 h-3.5" /> åŒ¯å‡º Excel (CSV)
                </button>
              </div>
              <div className="divide-y divide-slate-100 max-h-80 overflow-y-auto">
                {history.length === 0 ? ( <div className="p-8 text-center text-slate-400 italic">å°šæœªæœ‰é›²ç«¯æ´¾æ¡ˆç´€éŒ„</div> ) : (
                  history.map(item => (
                    <div key={item.id} className="p-4 flex items-center justify-between hover:bg-slate-50">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs">{item.assignee[0]}</div>
                        <div>
                          <p className="text-sm font-bold">{item.assignee}</p>
                          <p className="text-[10px] text-slate-400">{item.timeString}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <span className="text-sm font-mono font-bold text-blue-600">+{item.score}</span>
                        <div className="text-[9px] text-slate-400 uppercase font-bold">
                          {item.details.emcClass} | {item.details.caseType === 'new' ? 'NEW' : 'OLD'}
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>

          {/* Right Column */}
          <div className="space-y-6">
            {/* Leaderboard */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="bg-slate-800 text-white px-6 py-4 font-semibold flex items-center gap-2">
                <BarChart3 className="w-5 h-5 text-blue-400" />å·¥ç¨‹å¸«ç¸½ç©åˆ† (é›²ç«¯åŒæ­¥)
              </div>
              <div className="p-6 space-y-5">
                {members.sort((a,b) => b.totalScore - a.totalScore).map((m) => {
                  const maxScore = Math.max(...members.map(mem => mem.totalScore), 1);
                  const isLowest = m.id === recommendedMember?.id;
                  return (
                    <div key={m.id} className="space-y-1">
                      <div className="flex justify-between text-xs font-bold">
                        <span className={isLowest ? 'text-green-600 flex items-center gap-1' : 'text-slate-600'}>
                          {m.name} {isLowest && <CheckCircle2 className="w-3 h-3" />}
                        </span>
                        <span className="font-mono text-slate-400">{m.totalScore}</span>
                      </div>
                      <div className="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div className={`h-full transition-all duration-700 ${isLowest ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${(m.totalScore / maxScore) * 100}%` }}></div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Weights Configuration */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="px-6 py-4 border-b border-slate-100 text-slate-700 font-bold text-sm flex items-center gap-2">
                <Settings className="w-4 h-4" />æ¬Šé‡åƒæ•¸
              </div>
              <div className="p-4 space-y-3">
                {[
                  { label: 'æ–°æ¡ˆå€ç‡', key: 'newCase' },
                  { label: 'Class B ä¸­æ–‡åŠ æˆ', key: 'classB_CN_Extra' },
                  { label: 'è‹±æ–‡æ¬Šé‡', key: 'enReport' },
                  { label: 'ä¸­æ–‡æ¬Šé‡', key: 'cnReport' },
                ].map(w => (
                  <div key={w.key} className="flex items-center justify-between text-[10px]">
                    <span className="text-slate-500 font-bold">{w.label}</span>
                    <input type="number" step="0.1" className="w-12 p-1 text-right border rounded bg-slate-50 font-mono" value={weights[w.key]} onChange={(e) => setWeights({...weights, [w.key]: parseFloat(e.target.value) || 0})} />
                  </div>
                ))}
                <div className="mt-4 p-3 bg-indigo-50 rounded-xl text-[10px] text-indigo-700 border border-indigo-100">
                  <p className="font-bold mb-1 underline underline-offset-2">é›²ç«¯ç´€éŒ„èªªæ˜ï¼š</p>
                  1. è³‡æ–™è‡ªå‹•åŒæ­¥è‡³ Firestoreï¼Œè·¨è£ç½®å…±äº«ã€‚<br/>
                  2. é»æ“ŠåŒ¯å‡ºæŒ‰éˆ•å¯ä¸‹è¼‰ CSVï¼ŒExcel å¯ç›´æ¥é–‹å•Ÿã€‚<br/>
                  3. åŒ¯å‡ºæª”å…§å«æ¡ˆä»¶æ˜ç´°èˆ‡æ™‚é–“æˆ³ã€‚
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;